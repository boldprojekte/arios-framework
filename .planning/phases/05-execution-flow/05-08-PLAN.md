---
phase: 05-execution-flow
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/agents/executor.md
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Quality patterns are extracted from codebase before spawning executor"
    - "Patterns are persisted to .planning/patterns.json"
    - "Executor reads patterns.json and applies style when generating code"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/agents/executor.md"
      provides: "Pattern-aware code generation"
      contains: "Read tool.*patterns.json|code_style"
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Pattern extraction before executor spawn"
      contains: "Write tool.*patterns.json|Glob tool"
  key_links:
    - from: "orchestrate.md"
      to: ".planning/patterns.json"
      via: "Write tool persistence"
      pattern: "Write tool|patterns\\.json"
    - from: "executor.md"
      to: ".planning/patterns.json"
      via: "Read tool loading"
      pattern: "Read tool|patterns\\.json"
---

<objective>
Wire quality pattern extraction and enforcement into executor context.

Purpose: Close gap where pattern extraction exists but patterns are never injected into executor prompts. Generated code should match existing codebase conventions.

Output: Updated orchestrate.md and executor.md with quality pattern integration.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@packages/arios-cli/templates/.claude/agents/executor.md
@packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
@packages/arios-cli/src/quality/enforcement.ts
@packages/arios-cli/src/quality/pattern-extractor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pattern extraction to orchestrator</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Update /arios:orchestrate to extract patterns before spawning executor:

1. Add to Workflow section, before execution step:
   Insert new step: "Extract codebase patterns"

   **Pattern extraction using Claude tools (CRITICAL):**
   ```
   Use Glob tool to find existing code files:
   - Pattern: "src/**/*.{ts,tsx}" or "**/*.{ts,tsx}"

   Use Read tool on 3-5 representative files to analyze:
   - Indentation (tabs vs spaces, count spaces)
   - Quote style (single vs double)
   - Semicolon usage (yes/no)
   - Component structure (functional, class)
   - Export style (named, default)

   Use Write tool to persist patterns to .planning/patterns.json:
   {
     "indentation": { "type": "spaces", "size": 2 },
     "quotes": "single",
     "semicolons": true,
     "confidence": "high",
     "examples": {
       "component": "export function MyComponent() {...}",
       "function": "const myFunc = () => {...}"
     }
   }
   ```

2. Update Spawn Patterns section for Executor:
   Add code style context via file path:
   ```
   **Executor:**
   Use Task tool to spawn .claude/agents/executor.md

   Provide:
   - Plan file path
   - Wave number to execute
   - Task IDs for this wave
   - Problems directory path
   - **Patterns file path: .planning/patterns.json**

   Task description must include:
   "Read .planning/patterns.json for code style context"
   ```

3. Add fallback for new projects:
   If no existing code found (greenfield via Glob):
   - Write default patterns.json with sensible defaults:
     * Indentation: 2 spaces
     * Quotes: single
     * Semicolons: yes
     * Naming: kebab-case files, camelCase functions, PascalCase components

**Data transfer mechanism (ADDRESSES BLOCKER):**
- Orchestrator WRITES .planning/patterns.json using Write tool
- Orchestrator includes file path in Task spawn description
- Executor READS .planning/patterns.json using Read tool
- No TypeScript imports needed - Claude tools handle persistence
  </action>
  <verify>
Read updated orchestrate.md and confirm:
- Pattern extraction uses Glob to find files
- Pattern extraction uses Read to analyze files
- Pattern extraction uses Write to persist to .planning/patterns.json
- Executor spawn includes patterns.json file path
- Greenfield defaults documented
  </verify>
  <done>
orchestrate.md extracts patterns using Claude tools and persists to patterns.json for executor to read
  </done>
</task>

<task type="auto">
  <name>Task 2: Add pattern enforcement to executor</name>
  <files>packages/arios-cli/templates/.claude/agents/executor.md</files>
  <action>
Update executor.md to read and apply code style patterns:

1. Update Input section:
   Add new input parameter:
   ```
   - Patterns file path: .planning/patterns.json (from orchestrator)
   ```

2. Add new section after Input:
   ```
   <code_style>
   **Pattern loading (CRITICAL - do this first):**
   Use Read tool to load .planning/patterns.json
   Parse the JSON to get:
   - indentation.type (spaces/tabs)
   - indentation.size (number)
   - quotes (single/double)
   - semicolons (true/false)
   - examples.component (if present)
   - examples.function (if present)

   **When generating or modifying code:**
   1. Match detected indentation (use tabs or spaces as specified, use specified count)
   2. Use detected quote style consistently
   3. Follow detected semicolon convention
   4. Reference provided examples for structural patterns

   **If patterns.json doesn't exist, use sensible defaults:**
   - 2 spaces indentation
   - Single quotes
   - Semicolons
   - Named exports

   **CRITICAL**: Never mix styles within a file. Match existing patterns.
   </code_style>
   ```

3. Update Workflow section step 2:
   BEFORE executing any task:
   ```
   2a. Read .planning/patterns.json using Read tool
   2b. Parse code style patterns
   2c. Execute task (apply patterns when creating/modifying files)
   ```

4. Add verification guidance:
   In problem_reporting section, add:
   "Style violations: If generated code doesn't match project patterns, note in problem file"

**Data receive mechanism (ADDRESSES BLOCKER):**
- Executor receives patterns.json path in task description
- Executor uses Read tool to load patterns.json
- Executor applies patterns when using Write tool for code files
- No TypeScript imports - Claude reads JSON and applies rules
  </action>
  <verify>
Read updated executor.md and confirm:
- Input section includes patterns file path
- <code_style> section specifies Read tool to load patterns.json
- Workflow step 2a reads patterns before execution
- Problem reporting includes style violations
  </verify>
  <done>
executor.md reads patterns.json using Read tool and applies code style when generating code
  </done>
</task>

</tasks>

<verification>
1. Read packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
2. Verify pattern extraction step exists before executor spawn
3. Verify Code Style Context included in executor spawn
4. Read packages/arios-cli/templates/.claude/agents/executor.md
5. Verify <code_style> section exists with enforcement rules
6. Verify Input section includes code style context
</verification>

<success_criteria>
- Orchestrator extracts patterns from existing code before execution
- Executor receives code style context in spawn
- Executor enforces patterns when generating code
- Greenfield projects get sensible defaults
- Style violations are flagged as problems
</success_criteria>

<output>
After completion, create `.planning/phases/05-execution-flow/05-08-SUMMARY.md`
</output>
