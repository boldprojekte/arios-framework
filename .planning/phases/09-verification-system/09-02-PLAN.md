---
phase: 09-verification-system
plan: 02
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true

must_haves:
  truths:
    - "Orchestrator spawns verifier after each wave completes"
    - "Verifier receives aggregated diff for parallel waves"
    - "Orchestrator parses verifier return and acts on recommendation"
    - "Verification failures spawn recovery-agent before user sees issues"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Wave verification integration"
      contains: "Wave Verification"
  key_links:
    - from: "orchestrate.md"
      to: "verifier-agent.md"
      via: "Task tool spawn"
      pattern: "verifier-agent.md"
    - from: "orchestrate.md"
      to: "recovery-agent.md"
      via: "verification_failure context"
      pattern: "type: verification_failure"
---

<objective>
Integrate wave verification into the orchestrator execution flow. After each wave completes, orchestrator collects aggregated diff, spawns verifier, parses results, and either continues or spawns recovery.

Purpose: Automatic quality gates between waves without user intervention
Output: Updated orchestrate.md with wave verification section
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-verification-system/09-CONTEXT.md
@.planning/phases/09-verification-system/09-RESEARCH.md
@.planning/phases/08-parallel-execution/08-01-SUMMARY.md
@.planning/phases/08-parallel-execution/08-02-SUMMARY.md
@packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
@packages/arios-cli/templates/.claude/agents/recovery-agent.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add wave verification section to orchestrator</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Update orchestrate.md to add a new section "## Wave Verification (After Each Wave)" that replaces/enhances the existing "Checkpoint Verification" section.

**Location:** After "### Wave Execution Pattern" section, before "## Report" section.

**New section content:**

```markdown
## Wave Verification (After Each Wave)

**Purpose:** Verify work after wave completion before proceeding to next wave. Verification is silent unless issues found - user doesn't see success messages.

**When to run:**
- After each wave completes (all wave-executors return)
- Before starting next wave
- Verification is ALWAYS run (not optional)

**Steps:**

### 1. Collect Wave Results

After all wave-executors return:
```
Parse each return message:
- Extract commit hashes
- Extract files_modified from each plan
- Build aggregated file list (union of all files)
```

### 2. Generate Aggregated Diff (for parallel waves)

```bash
# If wave had multiple parallel plans:
git diff {first_commit}^..{last_commit} --name-only  # List changed files
git diff {first_commit}^..{last_commit}  # Full diff content
```

For single-plan waves, use that plan's commits only.

### 3. Load Verification Config

Use Read tool to load .planning/config.json:
```json
{
  "checkpoint": {
    "testCommand": "npm test",
    "buildCommand": "npm run build",
    "lintCommand": "npm run lint"
  }
}
```

If no checkpoint config, still run verifier for stub/integration checks.

### 4. Spawn Verifier

**No announcement to user** (verification is silent unless issues found).

Use Task tool to spawn verifier-agent.md:

```
<verification_context>
wave: {N}
tier: wave
plans_completed: [{plan IDs from this wave}]
files_changed: [{aggregated file list}]
commits: [{commit hashes from all wave-executors}]
diff: |
  {aggregated diff content - inlined}
config:
  test_command: {from config.json or null}
  build_command: {from config.json or null}
  lint_command: {from config.json or null}
</verification_context>
```

### 5. Parse Verifier Return

Look for "## VERIFICATION COMPLETE" in return message.

Extract:
- Status: passed | gaps_found | needs_review
- Recommendation: continue | recovery_needed | human_review
- Gaps section (if present)

### 6. Act on Verification Result

```
IF status == "passed" AND recommendation == "continue":
  # Silent success - no user message
  Proceed to next wave

ELSE IF status == "gaps_found" AND recommendation == "recovery_needed":
  Display brief: "Wave {N} verification found issues. Auto-fixing..."

  FOR each gap with severity == "blocker":
    Spawn recovery-agent with:
    <failure_context>
    type: verification_failure
    wave: {N}
    plan_id: verification
    attempt: {1-3}
    error: {gap.issue}
    files_affected: [{gap.file}]
    recent_commits: [{commits from this wave}]
    </failure_context>

    IF recovery succeeds:
      Re-run verification (loop back to step 4)

    IF recovery fails 3x:
      Escalate to user:
      "Wave {N} verification failed after 3 auto-fix attempts.
       Issue: {gap.issue}
       Options: Debug (d), Skip (s - if no downstream deps), Abort (a)"

ELSE IF status == "needs_review" AND recommendation == "human_review":
  # Defer to phase-end review (don't stop now)
  Log warning internally, continue to next wave
```

**Note:** Skip option follows same downstream dependency check as task failures (from 08-02).
```
  </action>
  <verify>
Section exists: `grep "Wave Verification" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Verifier spawn: `grep "verifier-agent.md" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Aggregated diff: `grep "aggregated diff" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
  </verify>
  <done>orchestrate.md has Wave Verification section with aggregated diff collection, verifier spawning, and result handling</done>
</task>

<task type="auto">
  <name>Task 2: Update wave execution pattern for verification integration</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Update the existing "### Wave Execution Pattern" section to integrate verification into the flow.

**Find the existing wave execution pattern section and modify step 6 ("Silent verification"):**

Change from:
```markdown
6. **Silent verification** (Phase 9 - no announcement unless issues found)
   - Verification runs but only reports if issues found
   - Auto-fix via recovery agent before blocking
```

To:
```markdown
6. **Wave verification** (automatic, silent on success)
   - After all wave-executors complete, run wave verification
   - See "## Wave Verification (After Each Wave)" section for full flow
   - Verification is silent unless issues found
   - Auto-fix via recovery-agent before escalating to user
   - Only proceed to next wave after verification passes
```

**Also update the "Collect results" step (step 4) to save commit info:**

Change from:
```markdown
4. **Collect results** (let all finish)
   - Let all wave-executors finish (don't stop on first failure)
   - Per CONTEXT.md: "Tasks in same wave are independent by definition"
   - Collect all return messages
```

To:
```markdown
4. **Collect results** (let all finish)
   - Let all wave-executors finish (don't stop on first failure)
   - Per CONTEXT.md: "Tasks in same wave are independent by definition"
   - Collect all return messages
   - **Extract and store commit hashes from each wave-executor return**
   - **Store for verification: commits[], files_modified[]**
```

**Add verification call after step 5:**

After the wave completion announcement, add:
```markdown
7. **Run wave verification**
   - Collect commits and files from step 4
   - Generate aggregated diff
   - Spawn verifier-agent.md (see Wave Verification section)
   - Handle result per decision tree
   - Only proceed to step 8 after verification passes
```
  </action>
  <verify>
Wave execution mentions verification: `grep -A5 "Wave verification" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Commit collection: `grep "commit hashes" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
  </verify>
  <done>Wave execution pattern integrates verification as step 7 between completion and next wave</done>
</task>

</tasks>

<verification>
- orchestrate.md has "## Wave Verification (After Each Wave)" section
- Section includes aggregated diff generation
- Section includes verification_context format for verifier
- Section includes decision tree for result handling
- Wave execution pattern references verification section
- Recovery spawning uses type: verification_failure
- Silent success pattern maintained (no user message on pass)
</verification>

<success_criteria>
1. Orchestrator spawns verifier after every wave completes
2. Parallel waves get aggregated diff from all commits
3. Verification is silent on success (no user message)
4. Verification failures spawn recovery-agent first
5. User only sees issues after 3 auto-fix attempts fail
6. Skip option respects downstream dependency check
</success_criteria>

<output>
After completion, create `.planning/phases/09-verification-system/09-02-SUMMARY.md`
</output>
