---
phase: 09-verification-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/agents/verifier-agent.md
autonomous: true

must_haves:
  truths:
    - "Verifier agent can run configured npm scripts (test, build, lint)"
    - "Verifier detects stub implementations in code"
    - "Verifier checks import/export consistency across files"
    - "Verifier returns structured gap report to orchestrator"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/agents/verifier-agent.md"
      provides: "Verification subagent prompt"
      min_lines: 150
  key_links:
    - from: "verifier-agent.md"
      to: "orchestrate.md"
      via: "## VERIFICATION COMPLETE return format"
      pattern: "VERIFICATION COMPLETE"
---

<objective>
Create the verifier agent that checks work after wave completion. The verifier runs npm scripts, detects stubs and wiring gaps, checks integration of parallel work, and returns structured results to orchestrator.

Purpose: Enable automatic quality checking after each wave without user intervention
Output: verifier-agent.md file in agents directory
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-verification-system/09-CONTEXT.md
@.planning/phases/09-verification-system/09-RESEARCH.md
@packages/arios-cli/templates/.claude/agents/recovery-agent.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create verifier agent prompt structure</name>
  <files>packages/arios-cli/templates/.claude/agents/verifier-agent.md</files>
  <action>
Create verifier-agent.md with the following structure:

**Frontmatter:**
```yaml
---
name: verifier-agent
description: Verifies wave completion - runs npm scripts, detects stubs, checks integration
tools: Read, Bash, Grep, Glob
model: sonnet
---
```

**Role section:**
- Verifier is internal to orchestration (does NOT communicate with user)
- Returns structured results to orchestrator
- Orchestrator decides what to do with results (continue, spawn recovery, escalate)

**Input format (verification_context):**
Expect inlined context from orchestrator with:
- wave: N
- tier: auto | wave | phase
- plans_completed: [plan IDs]
- files_changed: [file list]
- commits: [commit hashes]
- diff: (aggregated diff content for parallel waves)
- config: test_command, build_command, lint_command from .planning/config.json

**Workflow:**
1. Run configured npm scripts (test, build, lint) via Bash tool with 5-minute overall timeout
2. Perform stub detection on changed files (patterns from RESEARCH.md)
3. Perform integration checks (export/import consistency)
4. For parallel waves: check for conflicting modifications in aggregated diff
5. Collect all issues (don't stop at first failure)
6. Return structured result

**Stub detection patterns (from GSD):**
- TODO/FIXME/XXX/HACK/PLACEHOLDER keywords
- Empty implementations: return null, return {}, return []
- Single-line placeholder renders: return <div>...</div>
- Handler stubs: onClick={() => {}}, onSubmit with just preventDefault

**Integration check patterns:**
- Exports should be imported somewhere (orphaned exports = warning)
- API routes should be fetched somewhere (orphaned routes = warning)
- Type definitions should be used

**Output format:**
Return compact message (10-15 lines) for orchestrator:

```markdown
## VERIFICATION COMPLETE

**Status:** passed | gaps_found | needs_review
**Wave:** {N}
**Tier:** wave

### Checks
| Check | Result | Details |
|-------|--------|---------|
| npm test | PASS/FAIL | {summary} |
| npm build | PASS/FAIL | {summary} |
| npm lint | PASS/FAIL | {summary} |
| Code review | PASS/gaps_found | {count} issues |

### Gaps (if any)
<gaps>
- type: {stub_detected | wiring_missing | lint_error | integration_conflict}
  file: {path}
  issue: {description}
  severity: {blocker | warning}
</gaps>

### Recommendation
{continue | recovery_needed | human_review}
```

**Decision logic for recommendation:**
- All checks pass, no blockers -> continue
- Has blocker gaps -> recovery_needed
- npm scripts configured but all fail -> needs_review (might be config issue)
  </action>
  <verify>
File exists: `ls packages/arios-cli/templates/.claude/agents/verifier-agent.md`
Contains required sections: grep for "VERIFICATION COMPLETE", "verification_context", "stub detection", "integration check"
  </verify>
  <done>verifier-agent.md exists with role, input format, workflow, stub/integration patterns, and output format sections</done>
</task>

<task type="auto">
  <name>Task 2: Add stub detection and integration check patterns</name>
  <files>packages/arios-cli/templates/.claude/agents/verifier-agent.md</files>
  <action>
Enhance verifier-agent.md with detailed check patterns:

**Add stub_detection section:**
```markdown
<stub_detection>
## Stub Detection (run on each changed file)

**Universal stub patterns (use Grep tool):**
```bash
# Keyword markers
grep -E "(TODO|FIXME|XXX|HACK|PLACEHOLDER)" "$file"
grep -E "(implement|add later|coming soon|will be)" "$file" -i

# Empty implementations
grep -E "return null|return undefined|return \{\}|return \[\]" "$file"
grep -E "=> \{\}" "$file"
grep -E "throw new Error\('Not implemented" "$file"

# Placeholder content
grep -E "(placeholder|lorem ipsum)" "$file" -i
```

**React-specific patterns:**
```bash
# Single-line placeholder renders
grep -E "return <div>.*</div>$" "$file"

# Empty event handlers
grep -E "onClick=\{\(\) => \{\}\}" "$file"
grep -E "onSubmit=\{.*preventDefault\(\)[^}]*\}$" "$file"
```

**Severity mapping:**
- TODO/FIXME in implementation code -> blocker
- TODO/FIXME in comments only -> warning
- Empty return/handler -> blocker
- Placeholder text in UI -> warning
</stub_detection>
```

**Add integration_check section:**
```markdown
<integration_check>
## Integration Checks (for parallel wave aggregated diff)

**Export/Import consistency:**
1. Find all exports in changed files (using Grep)
2. For each export, check if imported anywhere in src/
3. New exports with no imports = warning (orphaned)

**API route consumption:**
1. Find route handlers in changed files (GET, POST, etc.)
2. Check for corresponding fetch/axios calls in src/
3. New routes with no consumers = warning

**Type compatibility (if TypeScript):**
1. Check for type imports across module boundaries
2. Flag if type is used but definition changed incompatibly

**Conflict detection (for parallel waves):**
1. Parse aggregated diff for same-file changes from different commits
2. If same file modified by multiple commits:
   - Check if changes touch same lines/functions
   - Same-function changes = blocker (potential conflict)
   - Different-function changes = warning (review recommended)
</integration_check>
```

**Add timeout_handling section:**
```markdown
<timeout_handling>
## Timeout Handling

Overall verification budget: 5 minutes

Per-command budgets:
- npm test: 3 minutes (most time-consuming)
- npm build: 1.5 minutes
- npm lint: 30 seconds

If command times out:
- Record as TIMEOUT in results
- Continue to next check
- Timeout on test = blocker
- Timeout on build = blocker
- Timeout on lint = warning
</timeout_handling>
```
  </action>
  <verify>
File contains stub detection patterns: `grep -E "TODO|FIXME|XXX" packages/arios-cli/templates/.claude/agents/verifier-agent.md`
File contains integration check section: `grep "integration_check" packages/arios-cli/templates/.claude/agents/verifier-agent.md`
File contains timeout handling: `grep "timeout" packages/arios-cli/templates/.claude/agents/verifier-agent.md`
  </verify>
  <done>verifier-agent.md has stub_detection, integration_check, and timeout_handling sections with specific patterns</done>
</task>

</tasks>

<verification>
- verifier-agent.md exists at packages/arios-cli/templates/.claude/agents/verifier-agent.md
- File has frontmatter with name, description, tools, model
- File has role section explaining verifier is internal (not user-facing)
- File has verification_context input format
- File has stub detection patterns (TODO/FIXME/empty returns)
- File has integration check patterns (export/import consistency)
- File has output format with ## VERIFICATION COMPLETE header
- File has recommendation logic (continue/recovery_needed/needs_review)
</verification>

<success_criteria>
1. verifier-agent.md is a complete, standalone agent prompt
2. Can be spawned by orchestrator with verification_context
3. Returns structured results that orchestrator can parse
4. Detects common stub patterns (from GSD research)
5. Checks integration of parallel work
6. Respects 5-minute overall timeout
</success_criteria>

<output>
After completion, create `.planning/phases/09-verification-system/09-01-SUMMARY.md`
</output>
