---
phase: 07-e2e-flow-role-clarity
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/plan.md
  - packages/arios-cli/templates/.claude/commands/arios/execute.md
  - packages/arios-cli/templates/.claude/commands/arios/ideate.md
autonomous: true

must_haves:
  truths:
    - "/plan refuses to proceed when CONTEXT.md is missing for the phase"
    - "/execute refuses to proceed when PLAN.md is missing for the phase"
    - "Each stage ends with clear 'Next:' prompt and '/clear first' tip"
    - "/ideate always works (no prerequisites)"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/plan.md"
      provides: "Hard prerequisite check for CONTEXT.md"
      contains: "CONTEXT.md"
    - path: "packages/arios-cli/templates/.claude/commands/arios/execute.md"
      provides: "Hard prerequisite check for PLAN.md"
      contains: "PLAN.md"
    - path: "packages/arios-cli/templates/.claude/commands/arios/ideate.md"
      provides: "Stage completion prompt with Next suggestion"
      contains: "Next:"
  key_links:
    - from: "plan.md"
      to: ".planning/phases/{phase}/*-CONTEXT.md"
      via: "Glob check for CONTEXT.md existence"
      pattern: "CONTEXT.md"
    - from: "execute.md"
      to: ".planning/phases/{phase}/*-PLAN.md"
      via: "Glob check for PLAN.md existence"
      pattern: "PLAN.md"
---

<objective>
Implement explicit stage boundaries with hard prerequisite checks and clear completion prompts.

Purpose: Users maintain control over workflow transitions and never accidentally run commands out of sequence. Each stage has a clear end point with guidance for what to do next.

Output: Updated /plan, /execute, and /ideate commands with prerequisite enforcement and stage completion prompts.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-e2e-flow-role-clarity/07-CONTEXT.md
@.planning/phases/07-e2e-flow-role-clarity/07-RESEARCH.md
@packages/arios-cli/templates/.claude/commands/arios/plan.md
@packages/arios-cli/templates/.claude/commands/arios/execute.md
@packages/arios-cli/templates/.claude/commands/arios/ideate.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hard prerequisite check to /plan command</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/plan.md</files>
  <action>
Update /arios:plan to enforce CONTEXT.md prerequisite:

1. Add prerequisite check section in Instructions:
   - Before any other action, use Glob to check for `.planning/phases/{phase}/*-CONTEXT.md`
   - If CONTEXT.md found: proceed with planning
   - If NOT found: display refusal message and stop (do NOT proceed)

2. Refusal message format (from RESEARCH.md):
```
## Cannot Plan

No ideation context found for this phase.

Expected: `.planning/phases/{phase}/{phase}-CONTEXT.md`

---

Run first: `/ideate`

Planning requires ideation findings as input.
```

3. Update Workflow section to make prerequisite check step 1 (before reading STATE.md)

4. Add stage completion prompt at end of Report section:
```
---

Stage complete: Planning finished for Phase {X}

Next: `/execute {phase}`

_Tip: Run `/clear` first for fresh context_

---
```

Key: The refusal is absolute - do NOT offer "continue anyway" option. Planning without ideation context produces poor results.
  </action>
  <verify>Read plan.md and confirm: (1) Glob check for CONTEXT.md exists, (2) refusal message format matches, (3) stage completion prompt with "Next:" and "/clear" tip exists</verify>
  <done>plan.md has hard prerequisite check that refuses without CONTEXT.md, with clear stage completion prompt</done>
</task>

<task type="auto">
  <name>Task 2: Add hard prerequisite check to /execute command</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/execute.md</files>
  <action>
Update /arios:execute to enforce PLAN.md prerequisite:

1. Add prerequisite check section in Instructions:
   - Before any other action, use Glob to check for `.planning/phases/{phase}/*-PLAN.md`
   - If PLAN.md found: proceed with execution
   - If NOT found: display refusal message and stop (do NOT proceed)

2. Refusal message format:
```
## Cannot Execute

No execution plan found for this phase.

Expected: `.planning/phases/{phase}/{phase}-*-PLAN.md`

---

Run first: `/plan {phase}`

Execution requires a plan to work from.
```

3. Update Workflow section to make prerequisite check step 1

4. Update stage completion prompt at end of Report for when phase completes:
```
---

Stage complete: Phase {X} execution finished

Next: `/ideate` (if more features to build) or `/arios:status` (to review)

_Tip: Run `/clear` first for fresh context_

---
```

5. For wave completion (not phase completion), simpler prompt:
```
---

Wave {N} complete. {remaining} wave(s) remaining.

Continue: `/execute {phase}`

---
```

Key: The refusal is absolute - do NOT offer "continue anyway" option.
  </action>
  <verify>Read execute.md and confirm: (1) Glob check for PLAN.md exists, (2) refusal message format matches, (3) wave completion and phase completion prompts exist</verify>
  <done>execute.md has hard prerequisite check that refuses without PLAN.md, with clear completion prompts</done>
</task>

<task type="auto">
  <name>Task 3: Add stage completion prompt to /ideate command</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/ideate.md</files>
  <action>
Update /arios:ideate to have explicit stage completion prompt:

1. Ideate has NO prerequisites (can run anytime per existing design)

2. Update the Report section to include stage completion prompt:
```
---

Stage complete: Ideation finished for {topic}

Findings: `.planning/phases/{phase}/{phase}-CONTEXT.md`

Next: `/plan {phase}`

_Tip: Run `/clear` first for fresh context_

---
```

3. Remove the simple "Next: /arios:plan" line and replace with the formatted block above

4. Ensure the completion prompt appears AFTER the orchestrator routing message, not before
  </action>
  <verify>Read ideate.md and confirm stage completion prompt with "Next:", file path reference, and "/clear" tip exists</verify>
  <done>ideate.md has clear stage completion prompt guiding user to /plan with context tip</done>
</task>

</tasks>

<verification>
1. Read all three command files and verify prerequisite checks and completion prompts
2. Confirm /ideate has no prerequisite check but does have completion prompt
3. Confirm /plan and /execute have hard refusal when prerequisites missing
4. Confirm all completion prompts follow consistent format with "Next:", file path, and "/clear" tip
</verification>

<success_criteria>
- /plan command refuses to proceed without CONTEXT.md, shows clear "Run first: /ideate" message
- /execute command refuses to proceed without PLAN.md, shows clear "Run first: /plan" message
- All three commands end with formatted stage completion prompt
- Prompts include "Next:" suggestion and "_Tip: Run /clear first_" subtext
- No "continue anyway" options offered when prerequisites missing
</success_criteria>

<output>
After completion, create `.planning/phases/07-e2e-flow-role-clarity/07-01-SUMMARY.md`
</output>
