---
phase: 11-smart-entry-mode-detection
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Mode detection persists across sessions (stored in config.json)"
    - "Mode routing works regardless of how many times user restarts Claude"
    - "Backwards compatible - defaults to project mode when no mode set"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Mode reading from config.json"
      contains: "config\\.json"
  key_links:
    - from: "orchestrate.md"
      to: "config.json mode field"
      via: "Read tool to load config"
      pattern: "@.planning/config.json"
---

<objective>
Fix mode storage location inconsistency in orchestrate.md

Purpose: Mode is written to config.json by arios.md, feature.md, and project.md, but orchestrate.md currently tries to read it from STATE.md frontmatter (which doesn't have a mode field). This disconnect means mode detection will always fail even when mode is properly set.

Output: Updated orchestrate.md that reads mode from config.json instead of STATE.md.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-smart-entry-mode-detection/11-CONTEXT.md
@.planning/phases/11-smart-entry-mode-detection/11-VERIFICATION.md
@packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
@packages/arios-cli/templates/.claude/commands/arios/arios.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Context section to load config.json</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
In orchestrate.md, find the "## Context" section (around line 153-158).

Update the context section to include config.json for mode reading:

```markdown
## Context

Read before any action:
- @.planning/STATE.md - Current project position and progress
- @.planning/config.json - Project settings, stack info, AND mode field
- Active roadmap and phase files as needed
```

The key change is emphasizing config.json contains the mode field.
  </action>
  <verify>
    1. Read orchestrate.md Context section and confirm it references config.json for mode
    2. Run: `grep "config\.json.*mode" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md` to confirm config.json mode reading exists
  </verify>
  <done>Context section explicitly mentions config.json contains mode field</done>
</task>

<task type="auto">
  <name>Task 2: Fix Mode Detection section to read from config.json</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Find the "## Mode Detection" section in orchestrate.md (around lines 160-181).

**Note:** This replaces the Mode Detection section from plan 11-03 which incorrectly reads from STATE.md frontmatter. The 11-03 section was a placeholder that assumed mode would be stored in STATE.md, but mode is actually written to config.json by arios.md, feature.md, and project.md.

Replace the entire Mode Detection section with:

```markdown
## Mode Detection

**Extract mode from config.json:**

When reading config.json, look for the mode field:
- `"mode": "feature"` - Feature-Mode (single-phase workflow)
- `"mode": "project"` - Project-Mode (multi-phase workflow)
- No mode field - Legacy state, treat as Project-Mode

**Store mode for routing decisions:**
```
mode = config.mode || "project"  // default to project for legacy states
```

**Mode affects:**
| Behavior | Feature-Mode | Project-Mode |
|----------|--------------|--------------|
| Roadmap checks | Skip | Required |
| Phase numbering | `feature-{name}` | `01-xxx`, `02-xxx` |
| Phase transitions | N/A (single phase) | Multi-phase flow |
| Completion behavior | Archive to .planning/archive/ | Mark phase complete, suggest next |
```

The key change: "Extract mode from config.json" instead of "Extract mode from STATE.md frontmatter".
  </action>
  <verify>Read orchestrate.md Mode Detection section and confirm it reads from config.json (not STATE.md)</verify>
  <done>Mode Detection section reads mode from config.json correctly</done>
</task>

<task type="auto">
  <name>Task 3: Update Workflow step 1 to read mode from config.json</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Find the "## Workflow" section step 1 (around line 298-300).

Update step 1 from:
```
1. Read STATE.md to determine current position AND mode
   - Extract mode from frontmatter (default: "project")
```

To:
```
1. Read STATE.md to determine current position, read config.json for mode
   - Extract mode from config.json (default: "project")
```

This ensures the workflow instructions align with the Mode Detection section.
  </action>
  <verify>Read orchestrate.md Workflow section step 1 and confirm it mentions config.json for mode</verify>
  <done>Workflow step 1 correctly indicates mode comes from config.json</done>
</task>

</tasks>

<verification>
- [ ] orchestrate.md Mode Detection section references config.json (not STATE.md)
- [ ] orchestrate.md Context section includes config.json with mode emphasis
- [ ] orchestrate.md Workflow step 1 mentions config.json for mode
- [ ] No references to "STATE.md frontmatter" for mode remain
- [ ] Default to "project" when no mode field is present
</verification>

<success_criteria>
- Orchestrator correctly reads mode from config.json where it is stored
- Mode detection aligns with how arios.md, feature.md, and project.md write mode
- Backwards compatible with legacy states (defaults to project mode)
</success_criteria>

<output>
After completion, create `.planning/phases/11-smart-entry-mode-detection/11-04-SUMMARY.md`
</output>
