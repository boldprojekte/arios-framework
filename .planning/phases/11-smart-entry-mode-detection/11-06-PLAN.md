---
phase: 11-smart-entry-mode-detection
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/plan.md
  - packages/arios-cli/templates/.claude/commands/arios/change-mode.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Feature-Mode planning creates single phase structure"
    - "Project-Mode planning uses numbered multi-phase structure"
    - "User can override mode with /arios:change-mode command"
    - "plan.md reads mode from config.json before workflow"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/plan.md"
      provides: "Mode-aware planning workflow"
      contains: "mode.*feature|project"
    - path: "packages/arios-cli/templates/.claude/commands/arios/change-mode.md"
      provides: "Mode override command"
      contains: "change.*mode"
  key_links:
    - from: "plan.md"
      to: "config.json mode field"
      via: "Read config.json for mode check"
      pattern: "config\\.json"
    - from: "change-mode.md"
      to: "config.json mode field"
      via: "Write new mode to config.json"
      pattern: "config\\.json"
---

<objective>
Add mode awareness to plan.md and create mode override command

Purpose: Currently plan.md has no mode awareness - it always expects a multi-phase roadmap structure. For Feature-Mode, planning should work with a single feature phase. Additionally, users need a way to change mode after initial detection if the system guessed wrong (MODE-03 requirement).

Output: Updated plan.md with mode-conditional logic, plus new /arios:change-mode command for mode override.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-smart-entry-mode-detection/11-CONTEXT.md
@.planning/phases/11-smart-entry-mode-detection/11-VERIFICATION.md
@packages/arios-cli/templates/.claude/commands/arios/plan.md
@packages/arios-cli/templates/.claude/commands/arios/ideate.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode reading to plan.md Context section</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/plan.md</files>
  <action>
In plan.md, find the "## Context" section (around lines 17-20).

Update it to include mode check:

```markdown
## Context

- `!ls .planning/ 2>/dev/null || echo "NO_PLANNING"`
- @.planning/STATE.md - Current project position
- @.planning/config.json - Project settings AND mode field
```

Add the config.json reference with mode emphasis.
  </action>
  <verify>Read plan.md Context section and confirm it includes config.json with mode reference</verify>
  <done>Context section includes config.json for mode reading</done>
</task>

<task type="auto">
  <name>Task 2: Add Mode-Aware Planning section to plan.md</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/plan.md</files>
  <action>
In plan.md, add a new "## Mode-Aware Planning" section AFTER the "## Instructions" section (around line 50, after the prerequisite check section).

Insert:

```markdown
## Mode-Aware Planning

**Read mode from config.json before planning:**

1. Read `.planning/config.json` and extract mode field
2. Default to "project" if no mode field

### Feature-Mode Planning

When mode == "feature":

1. **Phase structure:** Single phase in `feature-{name}/` folder
2. **Prerequisite check:** Look for CONTEXT.md in feature folder
   - Use Glob: `.planning/phases/feature-*/*-CONTEXT.md`
3. **No roadmap dependency:** Don't check for ROADMAP.md
4. **Plan output:** Create plans numbered within feature:
   - `feature-{name}/feature-01-PLAN.md`
   - `feature-{name}/feature-02-PLAN.md`
5. **Route to:** `/arios:orchestrate plan` with feature context

### Project-Mode Planning

When mode == "project":

1. **Phase structure:** Numbered phases from ROADMAP.md
2. **Prerequisite check:** Standard CONTEXT.md check in numbered phase folder
   - Use Glob: `.planning/phases/{phase}/*-CONTEXT.md`
3. **Requires ROADMAP.md:** Multi-phase coordination
4. **Plan output:** Plans numbered by phase:
   - `{phase}/{phase}-01-PLAN.md`
   - `{phase}/{phase}-02-PLAN.md`
5. **Route to:** `/arios:orchestrate plan` with phase context
```

This section documents the mode-specific planning behaviors.
  </action>
  <verify>Read plan.md and confirm it contains "## Mode-Aware Planning" section with Feature-Mode and Project-Mode subsections</verify>
  <done>plan.md contains Mode-Aware Planning section with both mode paths</done>
</task>

<task type="auto">
  <name>Task 3: Update plan.md Workflow with mode branching</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/plan.md</files>
  <action>
In plan.md, find the "## Workflow" section (around line 28).

Update the workflow to include mode check and branching. Replace the entire Workflow section:

```markdown
## Workflow

1. **Prerequisite check (MANDATORY - before anything else):**
   - **Read mode from config.json** (default: "project")
   - **If mode == "feature":**
     - Use Glob to check for `.planning/phases/feature-*/*-CONTEXT.md`
     - If CONTEXT.md found: proceed
     - If NOT found: display Feature-Mode refusal (see below)
   - **If mode == "project":**
     - Use Glob to check for `.planning/phases/{phase}/*-CONTEXT.md`
     - If CONTEXT.md found: proceed
     - If NOT found: display Project-Mode refusal (see below)
2. Check ARIOS initialized (ls .planning/ succeeds)
   - If not: "ARIOS not initialized. Run `arios init` first."
3. Read STATE.md for current position and active roadmap/phase
4. Display status: "Phase X/Y, Plan M/N"
5. **Route based on mode (see Mode-Aware Planning section for phase structure):**
   - **Feature-Mode:** Route to /arios:orchestrate plan with feature folder path
   - **Project-Mode:** Route to /arios:orchestrate plan with phase number
6. After completion, show stage completion prompt (see Report section)

### Feature-Mode Refusal

If no CONTEXT.md found for feature:

```
## Cannot Plan

No ideation context found for this feature.

Expected: `.planning/phases/feature-{name}/{name}-CONTEXT.md`

---

Run first: `/ideate`

Planning requires ideation findings as input.
```

### Project-Mode Refusal

If no CONTEXT.md found for phase (existing behavior):

```
## Cannot Plan

No ideation context found for this phase.

Expected: `.planning/phases/{phase}/{phase}-CONTEXT.md`

---

Run first: `/ideate`

Planning requires ideation findings as input.
```
```

Key changes:
- Mode check is part of prerequisite (step 1)
- Different CONTEXT.md paths for Feature-Mode vs Project-Mode
- Mode-specific refusal messages
  </action>
  <verify>Read plan.md Workflow section and confirm it includes mode check and Feature-Mode/Project-Mode branching</verify>
  <done>Workflow section includes mode check and mode-specific routing</done>
</task>

<task type="auto">
  <name>Task 4: Create /arios:change-mode command</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/change-mode.md</files>
  <action>
Create a new file: `packages/arios-cli/templates/.claude/commands/arios/change-mode.md`

Content:

```markdown
---
description: Change ARIOS mode (Feature-Mode or Project-Mode)
---

# /arios:change-mode

## Purpose

Override the current ARIOS mode if the system detected incorrectly. Use this when:
- System detected Feature-Mode but you want full project planning
- System detected Project-Mode but you just want to add a quick feature

## Context

- @.planning/STATE.md
- @.planning/config.json
- @.planning/ROADMAP.md

## Instructions

### 1. Check Current State

Read config.json and STATE.md to determine current mode and work status.

**Display current mode:**
```
## Current Mode

Mode: {Feature-Mode|Project-Mode|Not set}
Status: {active work description or "No active work"}
```

### 2. Offer Mode Switch

**If active work in progress:**

```
## Active Work Detected

You have active {mode} work: {phaseName}
Progress: {planIndex}/{totalPlans}

Changing mode will:
- Archive current work to .planning/archive/
- Clear state for fresh start

Are you sure you want to switch modes? (yes/no):
```

Wait for confirmation before proceeding.

**If no active work:**

```
Switch to:
1. Feature-Mode - focused, single-phase work
2. Project-Mode - multi-phase roadmap

Which mode? (1/2):
```

### 3. Execute Mode Change

**If user confirms switch with active work:**

1. Archive current work:
   - If Feature-Mode: Move `feature-{name}/` to `.planning/archive/feature-{name}/`
   - If Project-Mode: Move current phase to `.planning/archive/`
2. Clear STATE.md (reset frontmatter)
3. Update config.json with new mode
4. Display confirmation

**If no active work:**

1. Update config.json with new mode:
   ```json
   {
     "mode": "{feature|project}",
     ...
   }
   ```
2. Display confirmation

### 4. Display Confirmation

```
## Mode Changed

Previous: {old mode}
New: {new mode}

{If had active work: "Previous work archived to .planning/archive/"}

Run `/arios` to start with new mode.
```

## Workflow

1. Read config.json for current mode
2. Read STATE.md for work status
3. Display current mode and status
4. If active work: confirm archival, handle choice
5. If no active work: offer mode selection
6. Update config.json with new mode
7. If archiving: move files to archive
8. Display confirmation

## Report

### Mode Changed
```
## Mode Changed

Previous: {old mode}
New: {new mode}

Run `/arios` to start with new mode.
```

### Change Cancelled
```
Mode change cancelled. Current mode: {mode}
```
```
  </action>
  <verify>File exists at packages/arios-cli/templates/.claude/commands/arios/change-mode.md with complete command structure</verify>
  <done>/arios:change-mode command exists with mode switching logic</done>
</task>

</tasks>

<verification>
- [ ] plan.md reads mode from config.json in prerequisite check
- [ ] plan.md has Mode-Aware Planning section
- [ ] Feature-Mode planning uses feature-{name} folder structure
- [ ] Project-Mode planning uses numbered phase structure
- [ ] /arios:change-mode command file exists
- [ ] change-mode handles active work (archive before switch)
- [ ] change-mode works when no active work (direct switch)
</verification>

<success_criteria>
- Feature-Mode planning works with single feature phase structure
- Project-Mode planning preserves existing behavior
- Users can switch modes with /arios:change-mode
- Active work is safely archived before mode switch
- MODE-03 requirement (mode can be changed) is satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/11-smart-entry-mode-detection/11-06-SUMMARY.md`
</output>
