---
phase: 11-smart-entry-mode-detection
plan: 03
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true

must_haves:
  truths:
    - "Orchestrator reads mode from STATE.md frontmatter"
    - "Feature-Mode skips roadmap checks"
    - "Project-Mode follows multi-phase roadmap flow"
    - "Feature completion triggers archive workflow"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Mode-aware execution routing"
      contains: "mode.*feature|project"
  key_links:
    - from: "orchestrate.md"
      to: "STATE.md mode field"
      via: "reads mode from frontmatter"
      pattern: "mode:"
---

<objective>
Add mode-aware routing to orchestrate.md

Purpose: The orchestrator needs to route execution differently based on mode. Feature-Mode skips roadmap-related logic and has a single-phase lifecycle. Project-Mode follows the full multi-phase flow.

Output: Extended orchestrate.md with mode detection from STATE.md and mode-specific routing logic.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/STATE.md
@.planning/phases/11-smart-entry-mode-detection/11-CONTEXT.md
@.planning/phases/11-smart-entry-mode-detection/11-RESEARCH.md
@packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add mode extraction from STATE.md</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Add a new section after "## Context" called "## Mode Detection" in orchestrate.md.

Content:

```markdown
## Mode Detection

**Extract mode from STATE.md frontmatter:**

When reading STATE.md, parse the frontmatter for mode field:
- `mode: "feature"` - Feature-Mode (single-phase workflow)
- `mode: "project"` - Project-Mode (multi-phase workflow)
- No mode field - Legacy state, treat as Project-Mode

**Store mode for routing decisions:**
```
mode = STATE.mode || "project"  // default to project for legacy states
```

**Mode affects:**
| Behavior | Feature-Mode | Project-Mode |
|----------|--------------|--------------|
| Roadmap checks | Skip | Required |
| Phase numbering | `feature-{name}` | `01-xxx`, `02-xxx` |
| Phase transitions | N/A (single phase) | Multi-phase flow |
| Completion behavior | Archive to .planning/archive/ | Mark phase complete, suggest next |
```

This section should be placed BEFORE the "## Workflow" section since mode affects routing decisions.
  </action>
  <verify>Read orchestrate.md and confirm it contains: "## Mode Detection" section, mode extraction from STATE.md, mode affects table</verify>
  <done>orchestrate.md contains Mode Detection section with mode extraction and routing impact table</done>
</task>

<task type="auto">
  <name>Task 2: Add Feature-Mode specific routing</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Add a new section "## Feature-Mode Routing" after "## Mode Detection" in orchestrate.md.

Content:

```markdown
## Feature-Mode Routing

When mode == "feature", the workflow is simplified:

### Execution Flow (Feature-Mode)

1. **Skip roadmap checks** - Feature-Mode has no ROADMAP.md
2. **Phase is always the feature phase** - `.planning/phases/feature-{name}/`
3. **Execute plans normally** - Same wave/task execution as Project-Mode
4. **On feature complete:**
   - All plans in feature phase executed
   - STATUS becomes "complete"
   - Trigger archive workflow (see below)

### Feature Archive Workflow

When Feature-Mode work completes (all plans done, verification passed):

1. **Display completion:**
   ```
   ## Feature Complete

   **Feature:** {phaseName}
   **Plans executed:** {totalPlans}
   **Duration:** {calculated from first to last activity}

   The feature has been archived.

   Ready for next task. Run `/arios` to start something new.
   ```

2. **Archive feature files:**
   ```
   Move .planning/phases/feature-{name}/ to .planning/archive/feature-{name}/
   ```

3. **Clear mode:**
   - Update config.json: remove "mode" field or set to null
   - Archive or reset STATE.md

4. **Ready for fresh detection:**
   - Next `/arios` call will run mode detection (no mode set)

### Scope Creep Detection

During Feature-Mode planning, if planner detects:
- 4+ plans in the feature, OR
- 2+ waves of dependencies

Display:
```
## Feature Growing

This feature is getting complex:
- {plan_count} plans needed
- {wave_count} waves of dependencies

Would you like to switch to Project-Mode for better tracking?

Options:
1. **Switch** - Convert to Project-Mode (creates ROADMAP.md)
2. **Continue** - Keep as Feature-Mode (may be harder to track)

What would you like to do? (1/2):
```

Handle user choice:
- Switch: Create minimal ROADMAP.md with single phase, update mode to "project"
- Continue: Proceed with Feature-Mode (user's choice)
```

This section handles all Feature-Mode specific behavior that differs from Project-Mode.
  </action>
  <verify>Read orchestrate.md and confirm it contains: "## Feature-Mode Routing" section, archive workflow, scope creep detection with thresholds (4+ plans OR 2+ waves)</verify>
  <done>orchestrate.md contains Feature-Mode specific routing including archive workflow and scope creep detection</done>
</task>

<task type="auto">
  <name>Task 3: Update workflow section for mode-awareness</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Update the existing "## Workflow" section to incorporate mode-aware branching.

Find the Workflow section (starts with "1. Read STATE.md to determine current position") and update it:

Change step 1 to:
```
1. Read STATE.md to determine current position AND mode
   - Extract mode from frontmatter (default: "project")
```

After step 2 (auto-detection), add mode-aware branching:
```
2a. If mode == "feature":
    - Skip roadmap-related checks
    - Phase is always feature phase (feature-{name})
    - Skip to step 5 for execution (no multi-phase logic)

2b. If mode == "project":
    - Continue with normal flow (roadmap, phase transitions)
```

Update step 6 (after subagent returns) to be mode-aware:
```
6. After subagent returns:
   - Read handoff file (findings/plan/wave-result)
   - Update STATE.md with progress
   - Report results to user
   - **If Feature-Mode AND status == "complete":**
     - Run Feature Archive Workflow (see Feature-Mode Routing section)
   - **If Project-Mode AND phase complete:**
     - Suggest next phase or project completion
```

The workflow should check mode at key decision points rather than having separate flows.
  </action>
  <verify>Read orchestrate.md Workflow section and confirm it includes: mode extraction in step 1, mode branching (2a/2b), mode-aware completion handling in step 6</verify>
  <done>Workflow section includes mode-aware branching at key decision points</done>
</task>

</tasks>

<verification>
- [ ] orchestrate.md contains "## Mode Detection" section
- [ ] orchestrate.md contains "## Feature-Mode Routing" section
- [ ] Mode is extracted from STATE.md frontmatter
- [ ] Feature-Mode skips roadmap checks
- [ ] Feature archive workflow is documented
- [ ] Scope creep detection thresholds specified (4+ plans OR 2+ waves)
- [ ] Workflow section updated with mode-aware branching
</verification>

<success_criteria>
- Orchestrator reads mode from STATE.md and routes accordingly
- Feature-Mode execution skips roadmap logic
- Feature completion triggers archive workflow
- Scope creep during Feature-Mode planning prompts upgrade to Project-Mode
- Project-Mode continues to work exactly as before (backwards compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/11-smart-entry-mode-detection/11-03-SUMMARY.md`
</output>
