---
phase: 04-state-management
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/STATE.md
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "STATE.md has YAML frontmatter between --- delimiters at start of file"
    - "Frontmatter contains version, phase, planIndex, totalPhases, totalPlans, status, lastActivity, checksum fields"
    - "Checksum is valid MD5 hash (first 8 chars) of meaningful state fields"
    - "Existing content (decisions, session info) is preserved in body after frontmatter"
  artifacts:
    - path: ".planning/STATE.md"
      provides: "State file with YAML frontmatter structure"
      contains: "^---"
  key_links:
    - from: ".planning/STATE.md"
      to: "arios.md and status.md slash commands"
      via: "YAML frontmatter parsed by @file reference"
      pattern: "---.*version:.*phase:.*---"
---

<objective>
Convert STATE.md from plain markdown to YAML frontmatter format required by state-aware slash commands.

Purpose: Resume detection in /arios and status display in /arios:status depend on parsing YAML frontmatter from STATE.md. Current file is plain markdown with no frontmatter structure.

Output: STATE.md with valid YAML frontmatter containing all required fields, preserving existing content.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-state-management/04-VERIFICATION.md

Reference for frontmatter structure:
@packages/arios-cli/src/types/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Convert STATE.md to frontmatter format</name>
  <files>.planning/STATE.md</files>
  <action>
Read current .planning/STATE.md content to understand existing structure.

Create new file with YAML frontmatter followed by existing content:

1. Add frontmatter block at start (between --- markers)
2. Include all required fields from StateFrontmatter type:
   - version: "1.0.0"
   - phase: 4 (current phase from existing content)
   - planIndex: 2 (current plan from existing content - 2 of 2 complete)
   - totalPhases: 6 (from roadmap)
   - totalPlans: 2 (plans in phase 4)
   - status: "phase-complete" (per existing content)
   - lastActivity: "2026-01-24" (from existing content)
   - checksum: calculate using MD5 first 8 chars of {phase, planIndex, totalPhases, totalPlans, status}

3. Add current phase name for readability:
   - phaseName: "State Management"

4. Preserve ALL existing content after frontmatter:
   - Project Reference section
   - Current Position section
   - Performance Metrics section
   - Accumulated Context section
   - Session Continuity section

The existing markdown body already contains good status information - keep it all, just add the machine-parseable frontmatter header.

Checksum calculation (must match state.ts):
```javascript
const meaningful = {
  phase: 4,
  planIndex: 2,
  totalPhases: 6,
  totalPlans: 2,
  status: "phase-complete"
};
// MD5(JSON.stringify(meaningful)).slice(0, 8)
```

Calculate this checksum and include it in the frontmatter.
  </action>
  <verify>
Run: `head -20 .planning/STATE.md` to verify frontmatter exists at start.
Check: First line is `---`, contains `version:`, `phase:`, `checksum:` fields.
Run: `grep -c "^---$" .planning/STATE.md` should return 2 (opening and closing delimiters).
  </verify>
  <done>
STATE.md has valid YAML frontmatter with all required fields. Existing content preserved in body.
  </done>
</task>

<task type="auto">
  <name>Task 2: Validate frontmatter can be parsed</name>
  <files>.planning/STATE.md</files>
  <action>
Create a quick validation that the frontmatter is parseable:

Use Node.js one-liner to validate:
```bash
node -e "
const fs = require('fs');
const matter = require('gray-matter');
const content = fs.readFileSync('.planning/STATE.md', 'utf-8');
const parsed = matter(content);
console.log('Frontmatter fields:', Object.keys(parsed.data));
console.log('Phase:', parsed.data.phase);
console.log('Status:', parsed.data.status);
console.log('Checksum:', parsed.data.checksum);
if (!parsed.data.phase || !parsed.data.status || !parsed.data.checksum) {
  process.exit(1);
}
console.log('VALID');
"
```

Run this from the project root to verify gray-matter can parse the frontmatter correctly.
  </action>
  <verify>
Node.js validation script exits with code 0 and prints "VALID".
All expected fields are present in parsed.data output.
  </verify>
  <done>
STATE.md frontmatter is parseable by gray-matter, confirming compatibility with state utilities.
  </done>
</task>

</tasks>

<verification>
1. File .planning/STATE.md starts with `---` delimiter
2. Contains all StateFrontmatter fields (version, phase, planIndex, totalPhases, totalPlans, status, lastActivity, checksum)
3. Checksum is 8 hexadecimal characters
4. gray-matter can parse the frontmatter without errors
5. Existing content (decisions, metrics, session info) preserved in body
</verification>

<success_criteria>
- STATE.md has YAML frontmatter at start of file
- Frontmatter contains all required fields matching StateFrontmatter type
- Checksum calculated correctly using MD5 first 8 chars
- Existing markdown content preserved after frontmatter
- gray-matter validation passes
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-management/04-03-SUMMARY.md`
</output>
