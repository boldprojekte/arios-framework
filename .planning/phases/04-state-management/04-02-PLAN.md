---
phase: 04-state-management
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/arios.md
  - packages/arios-cli/templates/.claude/commands/arios/status.md
autonomous: true

must_haves:
  truths:
    - "/arios command detects resume vs fresh start and adapts display"
    - "Status shows mini table format with phase/plan position"
    - "Suggestions offer choice, not assertion (per CONTEXT.md)"
    - "State conflict prompts user collaboratively (per CONTEXT.md)"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/arios.md"
      provides: "State-aware entry point with resume detection"
      contains: "STATE.md"
    - path: "packages/arios-cli/templates/.claude/commands/arios/status.md"
      provides: "Mini table status display"
      contains: "table"
  key_links:
    - from: "packages/arios-cli/templates/.claude/commands/arios/arios.md"
      to: ".planning/STATE.md"
      via: "@file reference for Claude to read"
      pattern: "@\\.planning/STATE\\.md"
    - from: "packages/arios-cli/templates/.claude/commands/arios/status.md"
      to: ".planning/STATE.md"
      via: "@file reference for Claude to read"
      pattern: "@\\.planning/STATE\\.md"
---

<objective>
Integrate state persistence into ARIOS slash commands for session continuity.

Purpose: Enable users to resume work seamlessly by having /arios detect existing state and adapt its behavior accordingly.

Output: Updated slash commands that are state-aware, showing appropriate context on resume and detecting conflicts.

ARCHITECTURE NOTE: Slash commands are PROMPTS that instruct Claude what to do. They do NOT execute TypeScript code. Claude reads STATE.md directly using its Read tool (via @file references or explicit file reads), then parses the YAML frontmatter from the content. The TypeScript utilities from Plan 01 are for ARIOS orchestrator code, not slash commands.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-state-management/04-CONTEXT.md

# Prior plan output
@.planning/phases/04-state-management/04-01-SUMMARY.md

# Files to modify
@packages/arios-cli/templates/.claude/commands/arios/arios.md
@packages/arios-cli/templates/.claude/commands/arios/status.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update /arios command for state awareness</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/arios.md</files>
  <action>
Update the main /arios entry point to detect and respond to existing state.

IMPORTANT: Slash commands instruct Claude what to do. Claude reads files directly. Do NOT reference TypeScript imports - Claude will use @file references and its Read tool.

Update the Context section to load state:
```markdown
## Context

Load state if exists:
- @.planning/STATE.md

Check ARIOS initialization:
- `!ls .planning/ 2>/dev/null || echo "NO_PLANNING"`
```

Update the Instructions section for state detection:

1. **Check for existing state:**
   - Read @.planning/STATE.md
   - If file exists with valid YAML frontmatter, this is a RESUME session
   - If file doesn't exist but .planning/ exists, check for brownfield
   - If no .planning/, this is greenfield

2. **Resume flow (STATE.md exists with frontmatter):**
   - Parse the YAML frontmatter between `---` markers
   - Extract: phase, planIndex, totalPhases, totalPlans, status, checksum
   - Check for conflict: Calculate MD5 hash of (phase + planIndex + status), compare first 8 chars to stored checksum
   - If conflict (checksums don't match): Show collaborative message (per CONTEXT.md):
     "State file was modified. Something changed since last session.
     (continue with loaded state / describe what changed)"
   - If no conflict: Show mini status table (per CONTEXT.md):
     ```
     | Phase | Plan | Status |
     |-------|------|--------|
     | 2/6   | 1/3  | in-progress |
     ```
   - Offer choice: "Continue with Phase 2, or explore other options?"

3. **Fresh start flow (no STATE.md):**
   - Existing brownfield/greenfield detection (keep current logic)
   - After routing, state will be created by orchestrator

4. **Key CONTEXT.md requirements:**
   - Mini table + brief text (not verbose paragraphs)
   - Suggestions offer choice ("Continue with X, or do something else?") - not assertive
   - Never auto-fix conflicts - ask user

Keep the existing routing logic for greenfield/brownfield cases. Add the resume path as a FIRST check before those.
  </action>
  <verify>
Read the updated arios.md and confirm:
- Has @.planning/STATE.md in Context section
- Instructions mention parsing YAML frontmatter directly
- Has mini table format for status
- Has collaborative conflict message
- Does NOT reference TypeScript imports or function calls
- Preserves existing greenfield/brownfield logic
  </verify>
  <done>
/arios command instructs Claude to read STATE.md directly, parse frontmatter, display mini status table, handle conflicts collaboratively, and offer non-assertive suggestions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update /arios:status for state-based display</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/status.md</files>
  <action>
Update the status command to read from STATE.md and display formatted state.

IMPORTANT: Claude reads STATE.md directly. Do NOT reference TypeScript utilities.

Update Context section:
```markdown
## Context

Load state and config:
- @.planning/STATE.md
- @.planning/ROADMAP.md
```

Implement status display instructions:

1. **Read state directly:**
   - Read @.planning/STATE.md with Read tool
   - If file not found: "No project state found. Run /arios to get started."
   - Parse YAML frontmatter between `---` markers

2. **Display format (per CONTEXT.md - mini table + brief text):**
   ```
   ## Project Status

   | Phase | Plan | Status | Last Active |
   |-------|------|--------|-------------|
   | 2/6   | 1/3  | in-progress | 2026-01-24 |

   Currently working on: Phase 2 - Subagent System

   ### Recent Decisions
   - [2026-01-24] ESM-only with NodeNext module resolution
   - [2026-01-24] gray-matter for YAML frontmatter parsing

   ### Rejected Ideas
   - [2026-01-24] Full Handlebars templating (too complex for needs)
   ```

3. **Parse decisions from body:**
   - Look for decision bullet points in the markdown body
   - Decisions with `rejected: true` go under "Rejected Ideas"
   - Show last 5 positive decisions
   - Show last 3 negative decisions (if any)
   - Format: [date] decision text

4. **Suggestion at end:**
   - Non-assertive: "Continue with current phase, or /arios:help for other options?"

Keep output concise - this is a quick status check, not a full report.
  </action>
  <verify>
Read the updated status.md and confirm:
- Has @.planning/STATE.md in Context section
- Instructions say to read and parse file directly (not call TypeScript)
- Has mini table format
- Shows decisions (positive and negative)
- Non-assertive suggestion at end
  </verify>
  <done>
/arios:status instructs Claude to read STATE.md directly, display mini table with phase/plan position, show recent decisions including rejected ideas, and offer non-assertive continuation suggestion.
  </done>
</task>

</tasks>

<verification>
1. /arios command has three paths: resume (STATE.md exists), brownfield (no state but .planning), greenfield (nothing)
2. Status display uses mini table format per CONTEXT.md
3. Conflict detection asks user, doesn't auto-fix
4. Suggestions offer choice, not assertion
5. Negative decisions are displayed (per CONTEXT.md requirement)
6. Neither command references TypeScript imports - both instruct Claude to read files directly
</verification>

<success_criteria>
- Resume detection works (STATE.md present = resume flow)
- Mini table format matches CONTEXT.md specification
- Conflict handling is collaborative (ask user, never auto-fix)
- Suggestions use choice language ("Continue with X, or...")
- Status shows both positive and negative decisions
- Slash commands are prompts for Claude, NOT code that imports TypeScript utilities
</success_criteria>

<output>
After completion, create `.planning/phases/04-state-management/04-02-SUMMARY.md`
</output>
