---
phase: 02-subagent-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/src/utils/handoff.ts
  - packages/arios-cli/src/types/handoff.ts
  - packages/arios-cli/package.json
autonomous: true

must_haves:
  truths:
    - "Handoff files can be parsed with YAML frontmatter extraction"
    - "TypeScript types enforce consistent handoff structure"
    - "Handoff utilities can write versioned finding files"
    - "Write-then-read round-trip preserves handoff data integrity"
  artifacts:
    - path: "packages/arios-cli/src/types/handoff.ts"
      provides: "TypeScript interfaces for handoff format"
      exports: ["FindingsFrontmatter", "PlanFrontmatter", "ProblemFrontmatter", "HandoffFile"]
    - path: "packages/arios-cli/src/utils/handoff.ts"
      provides: "Parse and write handoff files"
      exports: ["parseHandoffFile", "writeHandoffFile", "getNextVersion"]
  key_links:
    - from: "packages/arios-cli/src/utils/handoff.ts"
      to: "gray-matter"
      via: "npm dependency"
      pattern: "import matter from 'gray-matter'"
---

<objective>
Create TypeScript types and utilities for the subagent handoff protocol.

Purpose: Establishes the foundation for structured communication between orchestrator and subagents. All agents will use this format to persist findings.

Output: TypeScript interfaces defining handoff structure, utility functions for parsing (gray-matter) and writing versioned handoff files.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-subagent-system/02-CONTEXT.md
@.planning/phases/02-subagent-system/02-RESEARCH.md

# Existing code patterns
@packages/arios-cli/src/utils/files.ts
@packages/arios-cli/src/utils/templates.ts
@packages/arios-cli/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install gray-matter and create handoff types</name>
  <files>
    packages/arios-cli/package.json
    packages/arios-cli/src/types/handoff.ts
  </files>
  <action>
1. Add gray-matter dependency:
   ```bash
   cd packages/arios-cli && npm install gray-matter && npm install -D @types/gray-matter
   ```

2. Create `src/types/handoff.ts` with TypeScript interfaces:
   - `HandoffType`: Union type of 'findings' | 'plan' | 'problem'
   - `HandoffStatus`: Union type of 'complete' | 'partial' | 'failed'
   - `Confidence`: Union type of 'high' | 'medium' | 'low'
   - `BaseFrontmatter`: Common fields (version, type, status, created, phase, agent)
   - `FindingsFrontmatter`: Extends base with confidence field
   - `PlanFrontmatter`: Extends base with tasks_created (number), task_ids (string[])
   - `ProblemFrontmatter`: Extends base with severity ('blocker' | 'warning' | 'info'), related_task (string)
   - `HandoffFile<T>`: Generic interface with frontmatter (T) and body (string)

Use explicit type exports (export type) for all interfaces.
  </action>
  <verify>
    - `ls packages/arios-cli/node_modules/gray-matter` confirms installation
    - `cat packages/arios-cli/src/types/handoff.ts` shows all interfaces
    - `cd packages/arios-cli && npx tsc --noEmit` compiles without errors
  </verify>
  <done>gray-matter installed, all handoff TypeScript interfaces defined and compile</done>
</task>

<task type="auto">
  <name>Task 2: Create handoff utilities</name>
  <files>packages/arios-cli/src/utils/handoff.ts</files>
  <action>
Create `src/utils/handoff.ts` with utility functions:

1. `parseHandoffFile<T>(filePath: string): Promise<HandoffFile<T>>`
   - Read file using fs-extra
   - Parse with gray-matter
   - Return typed object with frontmatter and body

2. `writeHandoffFile<T>(dirPath: string, frontmatter: T, body: string): Promise<string>`
   - Generate filename with version from frontmatter.version
   - Format as YAML frontmatter + markdown body
   - Write to dirPath/{type}-{version}.md (e.g., findings-001.md)
   - Return full path written

3. `getNextVersion(dirPath: string, type: HandoffType): Promise<string>`
   - Scan directory for existing files of that type
   - Parse version numbers (001, 001.1, 002, etc.)
   - Return next major version (e.g., "002" if 001 exists)

4. `formatTimestamp(): string`
   - Return ISO 8601 timestamp for created field

Use ESM imports with .js extensions for local modules. Import types from '../types/handoff.js'.
  </action>
  <verify>
    - File exists at `packages/arios-cli/src/utils/handoff.ts`
    - `cd packages/arios-cli && npx tsc --noEmit` compiles without errors
    - Functions are exported and have correct signatures
  </verify>
  <done>All handoff utility functions implemented with proper TypeScript typing</done>
</task>

<task type="auto">
  <name>Task 3: Add handoff module exports</name>
  <files>packages/arios-cli/src/index.ts</files>
  <action>
Update `src/index.ts` to re-export handoff utilities and types for programmatic use.

Add at top of file (after existing imports):
```typescript
// Handoff utilities for subagent communication
export * from './types/handoff.js';
export * from './utils/handoff.js';
```

This allows other tools to: `import { parseHandoffFile, FindingsFrontmatter } from 'arios'`

Note: Keep existing CLI setup unchanged. These are additional exports for library use.
  </action>
  <verify>
    - `grep "export.*handoff" packages/arios-cli/src/index.ts` shows exports
    - `cd packages/arios-cli && npx tsc --noEmit` compiles without errors
    - `cd packages/arios-cli && npm run build` succeeds
    - `ls packages/arios-cli/dist/types/handoff.js` exists
    - `ls packages/arios-cli/dist/utils/handoff.js` exists
  </verify>
  <done>Handoff module exports available from package entry point, build produces dist files</done>
</task>

<task type="auto">
  <name>Task 4: Integration test - handoff round-trip</name>
  <files>packages/arios-cli/src/utils/handoff.ts</files>
  <action>
Create a simple round-trip test to verify handoff utilities work with actual agent output format:

1. Create a temporary test script (inline in bash or as temp file):
   ```typescript
   import { writeHandoffFile, parseHandoffFile, formatTimestamp } from './utils/handoff.js';
   import { FindingsFrontmatter } from './types/handoff.js';
   import { mkdirp, remove } from 'fs-extra';
   import * as path from 'path';

   const testDir = '/tmp/handoff-test';

   async function test() {
     await mkdirp(testDir);

     const frontmatter: FindingsFrontmatter = {
       version: '001',
       type: 'findings',
       status: 'complete',
       created: formatTimestamp(),
       phase: 'test-phase',
       agent: 'researcher',
       confidence: 'high'
     };

     const body = `# Research Findings\n\nTest content here.\n\n## Key Points\n- Point 1\n- Point 2`;

     // Write
     const writtenPath = await writeHandoffFile(testDir, frontmatter, body);
     console.log('Written to:', writtenPath);

     // Read back
     const parsed = await parseHandoffFile<FindingsFrontmatter>(writtenPath);
     console.log('Parsed frontmatter:', parsed.frontmatter);
     console.log('Body length:', parsed.body.length);

     // Verify round-trip
     if (parsed.frontmatter.agent !== 'researcher') throw new Error('Agent mismatch');
     if (parsed.frontmatter.confidence !== 'high') throw new Error('Confidence mismatch');
     if (!parsed.body.includes('Key Points')) throw new Error('Body content missing');

     console.log('Round-trip test PASSED');
     await remove(testDir);
   }

   test().catch(e => { console.error('FAILED:', e); process.exit(1); });
   ```

2. Run the test:
   ```bash
   cd packages/arios-cli
   npx tsx -e "$(cat <<'EOF'
   // paste script here or reference temp file
   EOF
   )"
   ```

3. Clean up temp directory after test.

This verifies the handoff format works end-to-end before subagent prompts use it.
  </action>
  <verify>
    - Test script runs without errors
    - "Round-trip test PASSED" appears in output
    - No temp files remain after cleanup
  </verify>
  <done>Handoff utilities verified working with write-then-read round-trip test</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `cd packages/arios-cli && npm run build` succeeds
2. `ls packages/arios-cli/dist/types/handoff.js` exists
3. `ls packages/arios-cli/dist/utils/handoff.js` exists
4. Package compiles as valid ESM module
5. Round-trip test confirms write/read integrity
</verification>

<success_criteria>
- gray-matter dependency installed
- TypeScript interfaces define complete handoff protocol
- Utility functions can parse and write handoff files
- All code compiles without TypeScript errors
- Exports available from package entry point
- Round-trip test verifies write-then-read preserves data
</success_criteria>

<output>
After completion, create `.planning/phases/02-subagent-system/02-01-SUMMARY.md`
</output>
