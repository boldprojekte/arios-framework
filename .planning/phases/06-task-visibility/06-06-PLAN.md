---
phase: 06-task-visibility
plan: 06
type: execute
wave: 4
depends_on: ["06-05"]
files_modified:
  - packages/arios-cli/src/commands/dashboard.ts
  - packages/arios-cli/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Running 'arios dashboard' starts the dashboard server"
    - "CLI shows URL to open in browser"
    - "Server shuts down cleanly with Ctrl+C"
  artifacts:
    - path: "packages/arios-cli/src/commands/dashboard.ts"
      provides: "Dashboard CLI command"
      exports: ["dashboardCommand"]
  key_links:
    - from: "packages/arios-cli/src/commands/dashboard.ts"
      to: "packages/arios-dashboard/src/server/index.ts"
      via: "startServer import"
      pattern: "startServer"
    - from: "packages/arios-cli/src/index.ts"
      to: "packages/arios-cli/src/commands/dashboard.ts"
      via: "dashboardCommand import"
      pattern: "dashboardCommand"
---

<objective>
Create the CLI command that starts the dashboard server and opens it in the user's browser.

Purpose: This is the user's entry point to the dashboard. Running `arios dashboard` should start everything and provide clear feedback about what's running.
Output: Working CLI command that integrates dashboard into ARIOS workflow.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/06-task-visibility/06-CONTEXT.md
@packages/arios-cli/src/index.ts
@packages/arios-cli/src/commands/init.ts
@packages/arios-dashboard/src/server/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard command</name>
  <files>packages/arios-cli/src/commands/dashboard.ts</files>
  <action>
Create dashboard command following existing command patterns:

```typescript
import { Command } from 'commander';
import chalk from 'chalk';
import ora from 'ora';
import { spawn } from 'node:child_process';
import { existsSync } from 'node:fs';
import { resolve, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

export const dashboardCommand = new Command('dashboard')
  .description('Start the ARIOS dashboard for real-time task visibility')
  .option('-p, --port <port>', 'Port to run dashboard on', '3456')
  .option('--no-open', 'Do not open browser automatically')
  .action(async (options) => {
    const planningDir = resolve(process.cwd(), '.planning');

    // Check .planning directory exists
    if (!existsSync(planningDir)) {
      console.error(chalk.red('Error: No .planning directory found.'));
      console.error(chalk.gray('Run "arios init" first to set up the project.'));
      process.exit(1);
    }

    const spinner = ora('Starting dashboard server...').start();

    try {
      // Path to dashboard server entry
      const dashboardPath = resolve(__dirname, '../../arios-dashboard/dist/server/index.js');

      // Check if dashboard package is built
      if (!existsSync(dashboardPath)) {
        spinner.fail('Dashboard not built');
        console.error(chalk.yellow('Building dashboard...'));

        // Build dashboard package
        const buildProcess = spawn('npm', ['run', 'build'], {
          cwd: resolve(__dirname, '../../arios-dashboard'),
          stdio: 'inherit'
        });

        await new Promise((resolve, reject) => {
          buildProcess.on('close', (code) => {
            if (code === 0) resolve(null);
            else reject(new Error(`Build failed with code ${code}`));
          });
        });
      }

      // Start dashboard server as child process
      const serverProcess = spawn('node', [dashboardPath, planningDir, options.port], {
        stdio: ['ignore', 'pipe', 'pipe']
      });

      let started = false;

      serverProcess.stdout?.on('data', (data) => {
        const output = data.toString();
        if (output.includes('Dashboard running') && !started) {
          started = true;
          spinner.succeed('Dashboard server started');

          const url = `http://localhost:${options.port}`;
          console.log(chalk.green(`\nDashboard running at: ${chalk.bold(url)}`));

          if (options.open !== false) {
            // Open browser
            const openCmd = process.platform === 'darwin' ? 'open'
              : process.platform === 'win32' ? 'start' : 'xdg-open';
            spawn(openCmd, [url], { detached: true, stdio: 'ignore' }).unref();
          }

          console.log(chalk.gray('\nPress Ctrl+C to stop the dashboard\n'));
        }
      });

      serverProcess.stderr?.on('data', (data) => {
        console.error(chalk.red(data.toString()));
      });

      // Handle clean shutdown
      const cleanup = () => {
        console.log(chalk.yellow('\nShutting down dashboard...'));
        serverProcess.kill('SIGTERM');
        process.exit(0);
      };

      process.on('SIGINT', cleanup);
      process.on('SIGTERM', cleanup);

      // Keep process alive
      await new Promise(() => {}); // Never resolves, keeps running

    } catch (error) {
      spinner.fail('Failed to start dashboard');
      console.error(chalk.red(error instanceof Error ? error.message : String(error)));
      process.exit(1);
    }
  });
```
  </action>
  <verify>`cat packages/arios-cli/src/commands/dashboard.ts | grep "export const dashboardCommand"` shows export</verify>
  <done>Dashboard command created with server start, browser open, and clean shutdown</done>
</task>

<task type="auto">
  <name>Task 2: Register dashboard command in CLI</name>
  <files>packages/arios-cli/src/index.ts</files>
  <action>
Update CLI entry point to register dashboard command:

1. Add import:
```typescript
import { dashboardCommand } from './commands/dashboard.js';
```

2. Add command registration (near other command registrations):
```typescript
program.addCommand(dashboardCommand);
```

3. Verify command appears in help output
  </action>
  <verify>
    `cat packages/arios-cli/src/index.ts | grep "dashboardCommand"` shows import and usage
    `cd packages/arios-cli && npx tsx src/index.ts --help | grep dashboard` shows command listed
  </verify>
  <done>Dashboard command registered and appears in CLI help</done>
</task>

<task type="auto">
  <name>Task 3: Update dashboard server for CLI integration</name>
  <files>packages/arios-dashboard/src/server/index.ts</files>
  <action>
Update dashboard server to accept CLI arguments:

1. Parse command line arguments when run directly:
```typescript
// At end of file, check if running directly
if (process.argv[1] === fileURLToPath(import.meta.url)) {
  const planningDir = process.argv[2] || '.planning';
  const port = parseInt(process.argv[3] || '3456', 10);

  startServer(planningDir, port).then(({ port: actualPort }) => {
    console.log(`Dashboard running on port ${actualPort}`);
  }).catch((error) => {
    console.error('Failed to start dashboard:', error);
    process.exit(1);
  });
}
```

2. Update startServer signature if needed:
```typescript
export async function startServer(planningDir: string, port = 3456): Promise<{
  port: number;
  stop: () => Promise<void>;
}>
```

3. Add console output when server starts:
```typescript
server.listen(port, () => {
  console.log(`Dashboard running at http://localhost:${port}`);
});
```
  </action>
  <verify>
    `cd packages/arios-dashboard && npx tsx src/server/index.ts .planning 3456` starts server and shows "Dashboard running" message
  </verify>
  <done>Dashboard server accepts CLI args and outputs status for CLI wrapper</done>
</task>

</tasks>

<verification>
1. `cd packages/arios-cli && npm run build` - builds without errors
2. `arios dashboard --help` - shows command options
3. `arios dashboard` - starts server, opens browser, shows URL
4. Ctrl+C cleanly stops the server
5. `arios dashboard --port 4000` - uses custom port
6. `arios dashboard --no-open` - starts without opening browser
</verification>

<success_criteria>
- `arios dashboard` command is registered and shows in help
- Command starts dashboard server on port 3456 (or custom port)
- Browser opens automatically (unless --no-open)
- Clean shutdown on Ctrl+C
- Error message if .planning directory doesn't exist
</success_criteria>

<output>
After completion, create `.planning/phases/06-task-visibility/06-06-SUMMARY.md`
</output>
