---
phase: 10-debug-recovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
  - packages/arios-cli/templates/.planning/debug.log
autonomous: true

must_haves:
  truths:
    - "State integrity check runs before execution begins"
    - "Auto-fixable issues (checksum mismatch, future timestamp) are corrected silently"
    - "Unfixable issues prompt user before continuing"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Pre-execution integrity check section"
      contains: "State Integrity Check"
  key_links:
    - from: "orchestrate.md"
      to: "STATE.md"
      via: "integrity validation before spawning executors"
      pattern: "integrity.*check|validate.*state"
---

<objective>
Add pre-execution state integrity checks to orchestrator

Purpose: Catch corruption or drift in STATE.md before execution begins (DEBUG-01). When issues are auto-fixable, fix silently with a brief note. When unfixable, present clear options to user.

Output: Updated orchestrate.md with integrity validation section
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-debug-recovery/10-CONTEXT.md
@.planning/phases/10-debug-recovery/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add state integrity check section to orchestrate.md</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Add a new section "## State Integrity Check (Pre-Execution)" before the "## Workflow" section in orchestrate.md.

**Section must include:**

1. **When to run:** At /execute initiation, before any wave-executor spawning

2. **Checks to perform:**
   | Check | Detection | Auto-Fix | User Prompt |
   |-------|-----------|----------|-------------|
   | Checksum mismatch | Compute hash, compare to stored | Yes - recalculate and update | No |
   | Missing SUMMARY.md for "complete" plan | Check file exists | No | "Plan X marked complete but SUMMARY.md missing. Continue?" |
   | Missing PLAN.md for current position | Check file exists | No | "Plan X doesn't exist. Reset to last known plan?" |
   | Future timestamp | Compare lastActivity to now | Yes - set to now | No |
   | Phase out of range | Compare to totalPhases | No | "Phase X exceeds total (Y). Reset to phase Y?" |

3. **Auto-fix pattern:**
   ```
   If auto-fixable:
     Apply fix
     Display: "Fixed STATE.md drift" (one-liner)
     Continue execution
   ```

4. **User prompt pattern:**
   ```
   If not auto-fixable:
     Display: "State issue detected: {description}"
     Offer options: "Continue (c), Reset (r), Abort (a)"
     Wait for user choice before proceeding
   ```

5. **Execution flow integration:**
   - Integrity check happens AFTER reading STATE.md but BEFORE dashboard startup
   - If all checks pass silently, proceed
   - If auto-fixes applied, show brief note, proceed
   - If user prompted, wait for response

**Position in orchestrate.md:** Insert after "## Variables" section, before "## Dashboard Coordination"
  </action>
  <verify>
Run: `grep -n "State Integrity Check" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Expect: Section heading found
Run: `grep -c "checksum mismatch\|Missing SUMMARY\|Missing PLAN\|Future timestamp\|Phase out of range" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Expect: At least 5 matches (all check types documented)
  </verify>
  <done>orchestrate.md has State Integrity Check section with all 5 check types and auto-fix vs user-prompt patterns</done>
</task>

<task type="auto">
  <name>Task 2: Create debug.log template file</name>
  <files>packages/arios-cli/templates/.planning/debug.log</files>
  <action>
Create a placeholder debug.log file that will be populated during execution.

**File content:**
```
# ARIOS Debug Log

This file records errors encountered during execution that required user escalation.
Auto-fixed issues are NOT logged here (they're handled silently).

Format:
[TIMESTAMP] [TYPE] [PHASE-PLAN] Description
---

```

**Purpose:** Per CONTEXT.md, errors that reach escalation (3 retries failed) get logged here for history. Auto-corrected issues don't need logging.
  </action>
  <verify>
Run: `test -f packages/arios-cli/templates/.planning/debug.log && echo "exists"`
Expect: "exists"
Run: `head -3 packages/arios-cli/templates/.planning/debug.log`
Expect: Contains "ARIOS Debug Log"
  </verify>
  <done>debug.log template exists with format documentation</done>
</task>

</tasks>

<verification>
1. orchestrate.md contains "State Integrity Check" section
2. All 5 integrity check types are documented
3. Auto-fix pattern documented (silent fix + one-liner note)
4. User prompt pattern documented (options: Continue, Reset, Abort)
5. debug.log template file exists
</verification>

<success_criteria>
- `grep "State Integrity Check" orchestrate.md` returns match
- State checks run before execution starts (documented position)
- Auto-fixable issues handled silently
- Non-auto-fixable issues prompt user with clear options
- debug.log template ready for error persistence
</success_criteria>

<output>
After completion, create `.planning/phases/10-debug-recovery/10-01-SUMMARY.md`
</output>
