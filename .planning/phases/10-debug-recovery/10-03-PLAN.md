---
phase: 10-debug-recovery
plan: 03
type: execute
wave: 3
depends_on: ["10-02", "10-04"]
files_modified:
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
  - packages/arios-cli/templates/.claude/agents/recovery-agent.md
autonomous: true

must_haves:
  truths:
    - "Ambiguous requirements always escalate immediately (no auto-retry)"
    - "Extreme destructive actions always escalate immediately"
    - "External service issues always escalate immediately"
    - "User always knows WHY AI is asking for help"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Escalation trigger classification"
      contains: "ALWAYS-ESCALATE"
    - path: "packages/arios-cli/templates/.claude/agents/recovery-agent.md"
      provides: "Escalation detection patterns"
      contains: "escalate_immediately"
  key_links:
    - from: "orchestrate.md"
      to: "recovery-agent.md"
      via: "escalate_immediately flag in return"
      pattern: "escalate_immediately.*true"
---

<objective>
Add clear escalation triggers with user-appropriate messaging

Purpose: Certain failure types should NEVER auto-retry (DEBUG-03). User always knows WHY the AI is asking for help. Minimal action options (Retry, Skip) keep choices simple.

Output: Escalation classification in orchestrate.md, detection patterns in recovery-agent.md
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-debug-recovery/10-CONTEXT.md
@.planning/phases/10-debug-recovery/10-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add escalation detection to recovery-agent.md</name>
  <files>packages/arios-cli/templates/.claude/agents/recovery-agent.md</files>
  <action>
Add a new section "## Escalation Detection" before "## Output Format" in recovery-agent.md.

**Section content:**
```markdown
## Escalation Detection

Some failures should NEVER be auto-retried. Detect these and flag for immediate user escalation.

### ALWAYS-ESCALATE Categories

| Category | Detection Patterns | Why Escalate |
|----------|-------------------|--------------|
| Ambiguous requirements | Error mentions "unclear", "ambiguous", "which approach", multiple valid options | Claude unsure what user wants |
| Extreme destructive | Proposed fix includes: DROP TABLE, rm -rf, delete production, reset database, truncate | Risk too high for auto-fix |
| External service | Error contains: 401, 403, rate limit, ECONNREFUSED, network timeout, API key invalid | Claude can't fix auth/network |

### Detection Logic

Before attempting fix:
1. Parse error message against ALWAYS-ESCALATE patterns
2. If match found:
   - Set escalate_immediately: true
   - Skip fix attempt
   - Provide detailed diagnosis for user
   - Explain WHY user involvement needed

### Modified Output Format

When escalate_immediately: true, return:

```markdown
## RECOVERY ESCALATE

**Type:** {failure type}
**Category:** {ambiguous_requirements | extreme_destructive | external_service}
**Diagnosis:** {what's happening - technical details}
**Why User Needed:** {plain language explanation of why AI can't proceed}
**Suggested Action:** {what user should do}
```

### Examples

**Ambiguous:**
```
Error: "Should login use session or JWT? Both patterns exist in codebase."
Detection: "which" pattern + multiple options
-> RECOVERY ESCALATE: User must decide auth strategy
```

**Destructive:**
```
Proposed fix: "Run prisma migrate reset to fix schema"
Detection: "reset database" equivalent
-> RECOVERY ESCALATE: User must approve destructive action
```

**External:**
```
Error: "401 Unauthorized from Stripe API"
Detection: 401 + API reference
-> RECOVERY ESCALATE: User must check API credentials
```
```
  </action>
  <verify>
Run: `grep -n "Escalation Detection" packages/arios-cli/templates/.claude/agents/recovery-agent.md`
Expect: Section heading found
Run: `grep -n "RECOVERY ESCALATE" packages/arios-cli/templates/.claude/agents/recovery-agent.md`
Expect: New output format documented
  </verify>
  <done>recovery-agent.md has escalation detection patterns and RECOVERY ESCALATE output format</done>
</task>

<task type="auto">
  <name>Task 2: Add escalation handling to orchestrate.md</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Update the recovery handling sections in orchestrate.md to handle RECOVERY ESCALATE returns.

**Add after "## Spawning Recovery Agent" section:**
```markdown
## Handling Escalation

When recovery agent returns "## RECOVERY ESCALATE":

1. **Skip retry loop** - Do NOT increment attempt counter
2. **Parse escalation details:**
   - Category (why user is needed)
   - Diagnosis (what's happening)
   - Suggested action (what user should do)

3. **Present to user with clear explanation:**
   ```
   ## Help Needed

   **Issue:** {diagnosis in plain language}
   **Why I'm asking:** {category-specific explanation}

   {For ambiguous_requirements:}
   "I found multiple valid approaches and need you to decide."

   {For extreme_destructive:}
   "This fix would delete data. I need your approval before proceeding."

   {For external_service:}
   "This looks like an authentication or network issue I can't fix."

   **Suggested:** {suggested action}

   Options: Retry (r), Skip (s), Abort (a)
   ```

4. **Handle user response:**
   - Retry: User may have fixed external issue, restart recovery from attempt 1
   - Skip: Log to debug.log, continue (if no downstream deps)
   - Abort: Stop execution, preserve state
```

**Update "After recovery agent returns" section to check for RECOVERY ESCALATE:**
```
Parse return message:
- Look for "## RECOVERY COMPLETE" -> success flow
- Look for "## RECOVERY FAILED" -> retry or exhaust flow
- Look for "## RECOVERY ESCALATE" -> immediate user prompt (no retry)
```
  </action>
  <verify>
Run: `grep -n "Handling Escalation" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Expect: Section heading found
Run: `grep -n "RECOVERY ESCALATE" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Expect: Found in return parsing and handling sections
  </verify>
  <done>orchestrate.md handles RECOVERY ESCALATE returns with user-appropriate messaging</done>
</task>

</tasks>

<verification>
1. recovery-agent.md has ALWAYS-ESCALATE category table
2. recovery-agent.md has detection patterns for ambiguous/destructive/external
3. recovery-agent.md has RECOVERY ESCALATE output format
4. orchestrate.md parses RECOVERY ESCALATE returns
5. orchestrate.md presents clear "Why I'm asking" explanation to user
6. Minimal options offered: Retry, Skip, Abort
</verification>

<success_criteria>
- User ALWAYS knows WHY AI is asking for help
- Ambiguous requirements never auto-retry
- Destructive actions never auto-retry
- External service issues never auto-retry
- Simple action options (no confusing severity tiers)
</success_criteria>

<output>
After completion, create `.planning/phases/10-debug-recovery/10-03-SUMMARY.md`
</output>
