---
phase: 10-debug-recovery
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/templates/.claude/agents/recovery-agent.md
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true

must_haves:
  truths:
    - "Each recovery attempt spawns a fresh agent (no context pollution)"
    - "Previous attempt details are included in failure_context"
    - "Progress indicator shows attempt number during recovery"
  artifacts:
    - path: "packages/arios-cli/templates/.claude/agents/recovery-agent.md"
      provides: "Fresh spawn pattern with previous_attempts context"
      contains: "previous_attempts"
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Attempt counting and progress display"
      contains: "Fixing issue"
  key_links:
    - from: "orchestrate.md"
      to: "recovery-agent.md"
      via: "Task tool with previous_attempts in failure_context"
      pattern: "previous_attempts.*attempt_1|attempt_2"
---

<objective>
Enhance self-correction with fresh spawn pattern and attempt tracking

Purpose: Each recovery attempt spawns a completely new agent with previous attempt context (DEBUG-02). Avoid compounding bad assumptions by giving each attempt fresh context while informing it of what was tried before.

Output: Updated recovery-agent.md and orchestrate.md with fresh spawn semantics
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-debug-recovery/10-CONTEXT.md
@.planning/phases/10-debug-recovery/10-RESEARCH.md
@.planning/phases/08-parallel-execution/08-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add previous_attempts to recovery-agent.md input format</name>
  <files>packages/arios-cli/templates/.claude/agents/recovery-agent.md</files>
  <action>
Update the "## Input Format" section to include previous_attempts field.

**Update failure_context format to:**
```
<failure_context>
type: {task_failure | verification_failure}
wave: {N}
plan_id: {phase-plan}
attempt: {1-3}
error: {error message or verification gap description}
files_affected: [list of files]
recent_commits: [list of recent commits for context]
previous_attempts:
  - attempt: 1
    diagnosis: {what attempt 1 thought was wrong}
    fix_tried: {what attempt 1 did}
    result: {why it didn't work}
  - attempt: 2
    diagnosis: {what attempt 2 thought was wrong}
    fix_tried: {what attempt 2 did}
    result: {why it didn't work}
</failure_context>
```

**Add section after "## Input Format" explaining fresh spawn philosophy:**
```markdown
## Fresh Spawn Philosophy

Each recovery attempt is a NEW agent with fresh context. This avoids compounding bad assumptions from previous attempts.

**What you receive:**
- Current attempt number (1, 2, or 3)
- The original error
- Previous attempt history (diagnoses and outcomes)

**How to use previous_attempts:**
- Read what was tried before
- Avoid repeating the same fixes
- Build on insights from previous diagnoses
- Consider alternative root causes

**First attempt (no previous_attempts):** Analyze fresh, apply most likely fix
**Second attempt:** Previous fix didn't work - try alternative diagnosis
**Third attempt:** Two fixes failed - look for deeper root cause or external factors
```
  </action>
  <verify>
Run: `grep -n "previous_attempts" packages/arios-cli/templates/.claude/agents/recovery-agent.md`
Expect: Multiple matches (in format and philosophy sections)
Run: `grep -n "Fresh Spawn Philosophy" packages/arios-cli/templates/.claude/agents/recovery-agent.md`
Expect: Section heading found
  </verify>
  <done>recovery-agent.md has previous_attempts in input format and Fresh Spawn Philosophy section</done>
</task>

<task type="auto">
  <name>Task 2: Update orchestrator recovery spawning with progress indicator and attempt tracking</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
Update the "## Spawning Recovery Agent" section to include:

1. **Progress indicator pattern:**
   ```
   Before spawning recovery agent:
   Display: "Fixing issue (attempt {N}/3)..."
   ```

2. **Attempt history tracking:**
   ```
   Maintain attempt_history array during recovery loop:
   - After each attempt completes, record:
     * diagnosis (from RECOVERY COMPLETE/FAILED)
     * fix_tried (from recovery agent return)
     * result (success/failure reason)
   - Pass attempt_history as previous_attempts to next spawn
   ```

3. **Update failure_context template to include previous_attempts:**
   ```
   <failure_context>
   type: {task_failure | verification_failure}
   wave: {N}
   plan_id: {phase-plan}
   attempt: {attempt}
   error: {error details}
   files_affected: [list]
   recent_commits: [list]
   previous_attempts:
   {formatted attempt history - empty for attempt 1}
   </failure_context>
   ```

4. **Update display announcement:**
   ```
   ## Delegating to Recovery Agent

   **Purpose:** Diagnose and fix {failure type}
   **Scope:** {affected files}
   **Progress:** Fixing issue (attempt {N}/3)...

   Spawning recovery agent...
   ```
  </action>
  <verify>
Run: `grep -n "Fixing issue (attempt" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Expect: Progress indicator pattern found
Run: `grep -n "previous_attempts" packages/arios-cli/templates/.claude/commands/arios/orchestrate.md`
Expect: Found in failure_context template
  </verify>
  <done>orchestrate.md has progress indicator and passes previous_attempts to recovery agent</done>
</task>

</tasks>

<verification>
1. recovery-agent.md documents previous_attempts input field
2. recovery-agent.md has Fresh Spawn Philosophy section
3. orchestrate.md displays "Fixing issue (attempt N/3)..." before spawning
4. orchestrate.md builds and passes previous_attempts array
5. Each spawn is fresh (new Task call, not context continuation)
</verification>

<success_criteria>
- Fresh spawn pattern documented and implemented
- Progress indicator visible during recovery: "Fixing issue (attempt N/3)..."
- Previous attempt context passed to each new recovery spawn
- Recovery agent knows what was tried before and can avoid repeating
</success_criteria>

<output>
After completion, create `.planning/phases/10-debug-recovery/10-02-SUMMARY.md`
</output>
