---
phase: 12-state-dashboard-polish
plan: 05
type: execute
wave: 2
depends_on: ["12-03"]
files_modified:
  - packages/arios-dashboard/src/client/app.js
  - packages/arios-dashboard/src/client/styles.css
  - packages/arios-dashboard/src/server/index.ts
  - packages/arios-dashboard/src/server/parser.ts
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true

must_haves:
  truths:
    - "User can add a note from the detail panel"
    - "Notes are written to PLAN.md frontmatter"
    - "Claude reads notes on next action"
    - "Notes show timestamp when added"
  artifacts:
    - path: "packages/arios-dashboard/src/client/app.js"
      provides: "Add note UI interaction"
      contains: "addNote"
    - path: "packages/arios-dashboard/src/server/index.ts"
      provides: "POST /api/notes endpoint"
      contains: "/api/notes"
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Instructions for Claude to read notes"
      contains: "notes"
  key_links:
    - from: "Add Note button"
      to: "POST /api/notes"
      via: "fetch call"
      pattern: "fetch.*api/notes|POST"
    - from: "POST /api/notes"
      to: "PLAN.md notes array"
      via: "gray-matter stringify"
      pattern: "matter.stringify|notes"
    - from: "orchestrate.md"
      to: "PLAN.md frontmatter notes"
      via: "Claude reading instructions"
      pattern: "notes.*frontmatter|read.*notes"
---

<objective>
Add notes feature to detail panel that writes to state files.

Purpose: Per CONTEXT.md, notes from dashboard should be easy to add and visible to Claude. This creates communication from user to AI via persistent state.
Output: Add Note UI in panel, POST /api/notes endpoint, notes persisted in PLAN.md frontmatter, orchestrate.md updated to instruct Claude to read notes.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-state-dashboard-polish/12-CONTEXT.md
@.planning/phases/12-state-dashboard-polish/12-RESEARCH.md
@.planning/phases/12-state-dashboard-polish/12-03-SUMMARY.md (if available, for panel context)
@packages/arios-dashboard/src/client/app.js
@packages/arios-dashboard/src/server/index.ts
@packages/arios-dashboard/src/server/parser.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add POST /api/notes endpoint</name>
  <files>packages/arios-dashboard/src/server/index.ts</files>
  <action>
  Add a new API endpoint to handle note additions.

  In the request handler, add a new route for POST /api/notes:
  ```typescript
  if (req.method === 'POST' && pathname === '/api/notes') {
    let body = '';
    req.on('data', chunk => { body += chunk; });
    req.on('end', async () => {
      try {
        const { taskId, content, planPath } = JSON.parse(body);

        // Read existing plan file
        const planContent = await fs.readFile(planPath, 'utf-8');
        const { data: frontmatter, content: markdown } = matter(planContent);

        // Add note to frontmatter
        const notes = frontmatter.notes || [];
        notes.push({
          timestamp: new Date().toISOString(),
          content: content
        });

        // Save back with updated notes
        const updated = matter.stringify(markdown, { ...frontmatter, notes });
        await fs.writeFile(planPath, updated, 'utf-8');

        res.writeHead(200, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ success: true, noteCount: notes.length }));
      } catch (error) {
        res.writeHead(500, { 'Content-Type': 'application/json' });
        res.end(JSON.stringify({ error: error.message }));
      }
    });
    return;
  }
  ```

  Import fs/promises at top if not already imported:
  ```typescript
  import { promises as fs } from 'node:fs';
  ```

  Import gray-matter if not already:
  ```typescript
  import matter from 'gray-matter';
  ```
  </action>
  <verify>`cd packages/arios-dashboard && npm run build` compiles without errors</verify>
  <done>POST /api/notes endpoint exists that writes notes to PLAN.md frontmatter</done>
</task>

<task type="auto">
  <name>Task 2: Add notes UI to detail panel</name>
  <files>packages/arios-dashboard/src/client/app.js, packages/arios-dashboard/src/client/styles.css</files>
  <action>
  Update app.js `renderTaskDetailHTML` function to include notes section and add-note form.

  In renderTaskDetailHTML, add after existing detail sections:
  ```javascript
  // Notes section
  const notesSection = task.notes?.length > 0
    ? task.notes.map(note => `
        <div class="note-item">
          <span class="note-time">${new Date(note.timestamp).toLocaleString()}</span>
          <p class="note-content">${note.content}</p>
        </div>
      `).join('')
    : '<p class="empty-state">No notes yet</p>';

  return `
    ${existingDetailSections}
    <div class="detail-section notes-section">
      <div class="detail-label">Notes</div>
      <div class="notes-list">
        ${notesSection}
      </div>
      <div class="add-note-form">
        <textarea
          id="note-input"
          class="note-textarea"
          placeholder="Add a note for Claude..."
          rows="2"
        ></textarea>
        <button id="add-note-btn" class="add-note-btn" data-task-id="${task.id}" data-plan-path="${task.planPath || ''}">
          Add Note
        </button>
      </div>
    </div>
  `;
  ```

  Add event listener for add-note button in setupEventListeners or after panel opens:
  ```javascript
  // In showTaskDetail, after setting innerHTML:
  const addNoteBtn = document.getElementById('add-note-btn');
  addNoteBtn?.addEventListener('click', handleAddNote);

  async function handleAddNote(e) {
    const taskId = e.target.dataset.taskId;
    const planPath = e.target.dataset.planPath;
    const input = document.getElementById('note-input');
    const content = input?.value?.trim();

    if (!content) return;

    try {
      const response = await fetch('/api/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taskId, content, planPath })
      });

      if (response.ok) {
        input.value = '';
        // Re-render to show new note (will come via SSE update)
      }
    } catch (error) {
      console.error('[ARIOS] Failed to add note:', error);
    }
  }
  ```

  Add to styles.css:
  ```css
  /* Notes in detail panel */
  .notes-section {
    margin-top: var(--spacing-lg);
    border-top: 1px solid var(--border-subtle);
    padding-top: var(--spacing-lg);
  }

  .notes-list {
    margin-bottom: var(--spacing-md);
  }

  .note-item {
    padding: var(--spacing-sm);
    margin-bottom: var(--spacing-sm);
    background-color: var(--bg-tertiary);
    border-radius: var(--radius-sm);
  }

  .note-time {
    font-size: 11px;
    color: var(--text-muted);
    display: block;
    margin-bottom: var(--spacing-xs);
  }

  .note-content {
    font-size: 13px;
    color: var(--text-secondary);
    margin: 0;
  }

  .add-note-form {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .note-textarea {
    width: 100%;
    padding: var(--spacing-sm);
    background-color: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius-sm);
    color: var(--text-primary);
    font-family: inherit;
    font-size: 13px;
    resize: vertical;
  }

  .note-textarea:focus {
    outline: none;
    border-color: var(--accent);
  }

  .add-note-btn {
    align-self: flex-end;
    padding: var(--spacing-sm) var(--spacing-md);
    background-color: var(--accent);
    color: white;
    border: none;
    border-radius: var(--radius-sm);
    font-size: 13px;
    cursor: pointer;
    transition: background-color var(--transition-fast);
  }

  .add-note-btn:hover {
    background-color: var(--accent);
    opacity: 0.9;
  }
  ```
  </action>
  <verify>Start dashboard, open a task detail panel, verify notes section appears with textarea and Add Note button</verify>
  <done>Detail panel has notes section with existing notes display and add-note form that posts to /api/notes</done>
</task>

<task type="auto">
  <name>Task 3: Include planPath in task data from parser</name>
  <files>packages/arios-dashboard/src/server/parser.ts</files>
  <action>
  Update the parser to include the planPath in task objects so the client knows where to write notes.

  **Implementation:** The parser already knows the file path when parsing each PLAN.md file.
  When iterating through PLAN.md files to extract tasks:

  1. The parser receives or constructs the path to each PLAN.md (e.g., `.planning/phases/12-state-dashboard-polish/12-01-PLAN.md`)
  2. Store this path in a variable (e.g., `planFilePath`) before parsing
  3. When creating each task object from that file, include the path:

  ```typescript
  // During PLAN.md parsing loop
  const planFilePath = path.join(phaseDir, planFile);  // Already have this from file iteration
  const planContent = await fs.readFile(planFilePath, 'utf-8');
  const { data: frontmatter, content: markdown } = matter(planContent);

  // When creating task objects from this plan:
  const task = {
    id: taskId,
    name: taskName,
    status: taskStatus,
    // ... other existing fields
    planPath: planFilePath,  // ADD THIS: absolute path to the PLAN.md containing this task
    notes: frontmatter.notes || [],  // Also include existing notes for display
  };
  ```

  The planPath should be the absolute path to the PLAN.md file.
  This enables the /api/notes endpoint to know exactly which file to update.
  </action>
  <verify>Read parser.ts and confirm task objects include planPath field populated from the file path during parsing</verify>
  <done>Parser includes planPath in task objects, derived from the PLAN.md file path during iteration</done>
</task>

<task type="auto">
  <name>Task 4: Update orchestrate.md to instruct Claude to read notes</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
  Add a "Reading User Notes" section to orchestrate.md that instructs Claude to check for notes before executing tasks.

  Position: Near the beginning of task execution flow, after loading PLAN.md.

  Content to add:
  ```markdown
  ### Reading User Notes

  Before executing any task, check PLAN.md frontmatter for user notes:

  ```bash
  # Extract notes from frontmatter
  !grep -A 100 '^notes:' {plan_path} | grep -B 100 '^[a-z]' | head -n -1
  ```

  Or when parsing with gray-matter:
  ```
  const { data: frontmatter } = matter(planContent);
  if (frontmatter.notes?.length > 0) {
    // Display notes to acknowledge user context
  }
  ```

  **If notes exist:**
  1. Read all notes before starting task execution
  2. Acknowledge the notes briefly: "Note from user: {summary}"
  3. Consider note content when making implementation decisions
  4. Notes may contain:
     - Clarifications about requirements
     - Warnings about edge cases
     - Preferences for implementation approach
     - Context that wasn't in the original plan

  **Key principle:** Notes are user-to-Claude communication. Always read them.
  ```

  This ensures Claude actually reads the notes that users add via the dashboard.
  </action>
  <verify>Read orchestrate.md and confirm "Reading User Notes" section exists with instructions to check frontmatter.notes</verify>
  <done>orchestrate.md instructs Claude to read notes from PLAN.md frontmatter before task execution</done>
</task>

</tasks>

<verification>
- POST /api/notes endpoint accepts taskId, content, planPath and writes to PLAN.md frontmatter
- Detail panel shows existing notes with timestamps
- Add Note textarea and button appear in panel
- Clicking Add Note sends POST to /api/notes
- Notes persist in PLAN.md frontmatter as YAML array
- Parser includes planPath in task objects (derived from file iteration path)
- orchestrate.md instructs Claude to read notes before executing tasks
- Claude can read notes via gray-matter when loading plan
</verification>

<success_criteria>
- DASH-01 extended: Click-for-details now includes note capability
- Notes written to PLAN.md frontmatter per RESEARCH.md recommendation
- User can communicate context to Claude via notes
- Timestamps included per CONTEXT.md requirement
- Claude explicitly instructed to read notes (key link closed)
</success_criteria>

<output>
After completion, create `.planning/phases/12-state-dashboard-polish/12-05-SUMMARY.md`
</output>
