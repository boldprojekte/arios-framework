---
phase: 12-state-dashboard-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/arios-cli/src/types/state.ts
  - packages/arios-cli/src/utils/state.ts
  - packages/arios-cli/templates/.claude/commands/arios/orchestrate.md
autonomous: true

must_haves:
  truths:
    - "Drift detection runs before /execute begins"
    - "Checksum mismatch auto-fixes silently"
    - "Missing files prompt user with Fix/Reset/Abort options"
    - "State claims vs file reality mismatch is detected"
  artifacts:
    - path: "packages/arios-cli/src/types/state.ts"
      provides: "DriftResult type definition"
      contains: "DriftResult"
    - path: "packages/arios-cli/src/utils/state.ts"
      provides: "detectDrift function"
      exports: ["detectDrift"]
    - path: "packages/arios-cli/templates/.claude/commands/arios/orchestrate.md"
      provides: "Pre-execute drift detection step"
      contains: "Drift Detection"
  key_links:
    - from: "orchestrate.md"
      to: "drift detection logic"
      via: "Pre-Execute Drift Detection section"
      pattern: "state.*drift|DriftResult"
---

<objective>
Add drift detection that validates state claims against file system reality before execution.

Purpose: Prevent execution on stale or corrupted state by detecting when files have changed outside ARIOS or when state claims progress that files don't show.
Output: DriftResult type, detectDrift function, and orchestrate.md wiring that runs drift check before /execute.
</objective>

<execution_context>
@/Users/j.franke/.claude/get-shit-done/workflows/execute-plan.md
@/Users/j.franke/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-state-dashboard-polish/12-CONTEXT.md
@.planning/phases/12-state-dashboard-polish/12-RESEARCH.md
@packages/arios-cli/src/utils/state.ts
@packages/arios-cli/src/types/state.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add DriftResult type and detectDrift function</name>
  <files>packages/arios-cli/src/types/state.ts, packages/arios-cli/src/utils/state.ts</files>
  <action>
  Add to state.ts types:
  ```typescript
  export type DriftResult = {
    drifted: boolean;
    type: 'none' | 'file_changes' | 'state_mismatch';
    details: string[];
    autoFixable: boolean;
  };
  ```

  Add to state.ts utils a new `detectDrift` function:
  ```typescript
  export async function detectDrift(
    statePath: string,
    planningDir: string
  ): Promise<DriftResult>
  ```

  Implementation logic:
  1. Load state via loadProjectState
  2. Check 1: If stored checksum !== calculated checksum -> file_changes (autoFixable: true)
  3. Check 2: If state.status is 'complete' or 'in-progress':
     - Find the expected SUMMARY.md path for current phase/plan
     - If state claims complete but SUMMARY.md missing -> state_mismatch (autoFixable: false)
  4. Check 3: If PLAN.md for current phase/plan is missing -> state_mismatch (autoFixable: false)
  5. Return DriftResult with details array listing what drifted

  Use glob pattern matching with `fs.existsSync` to check for SUMMARY and PLAN files.
  Pattern: `${planningDir}/phases/${padded_phase}-*/${phase}-${padded_plan}-*.md`

  Export detectDrift from index.ts.
  </action>
  <verify>TypeScript compiles without errors: `cd packages/arios-cli && npm run build`</verify>
  <done>DriftResult type exists in state.ts types, detectDrift function exists in state.ts utils, both exported from index.ts</done>
</task>

<task type="auto">
  <name>Task 2: Wire drift detection into orchestrate.md</name>
  <files>packages/arios-cli/templates/.claude/commands/arios/orchestrate.md</files>
  <action>
  Add a "Pre-Execute Drift Detection" section AFTER State Integrity Check, BEFORE Dashboard Start.

  Section content:
  ```markdown
  ### Pre-Execute Drift Detection

  Before starting execution, verify state claims match file system reality.

  **Run drift detection:**
  1. Read STATE.md frontmatter
  2. Compare stored checksum vs calculated checksum
  3. If state claims plan complete, verify SUMMARY.md exists
  4. If state references current PLAN.md, verify it exists

  **If drift detected:**

  **Auto-fixable (checksum mismatch only):**
  - Show one-liner: "State checksum updated (files unchanged)"
  - Recalculate and save new checksum silently
  - Continue execution

  **Not auto-fixable (state_mismatch):**
  - Show what drifted: list each item in details array
  - Prompt user:
    ```
    State drift detected:
    - [detail 1]
    - [detail 2]

    Options:
    1. Fix it (reset state to match files)
    2. Reset state (revert to previous valid state)
    3. Abort (stop for manual investigation)
    ```
  - Wait for user selection before proceeding

  **If no drift:**
  - Continue silently (no message)
  ```

  Position this section at step 3.5 (after state read at step 3, before dashboard at step 4).
  </action>
  <verify>Read orchestrate.md and confirm "Pre-Execute Drift Detection" section exists with all three handling paths (auto-fix, prompt, silent continue)</verify>
  <done>orchestrate.md contains drift detection section positioned after state read, with auto-fix path for checksum and user-prompt path for state_mismatch</done>
</task>

</tasks>

<verification>
- DriftResult type compiles with all required fields
- detectDrift function handles all three cases: no drift, file_changes, state_mismatch
- orchestrate.md has drift detection section at correct position in workflow
- Build passes: `cd packages/arios-cli && npm run build`
</verification>

<success_criteria>
- STATE-02 partially addressed: Drift detection infrastructure exists and is wired into /execute flow
- Auto-fix for checksum silently resolves benign drift
- State/file mismatch prompts user with three options
</success_criteria>

<output>
After completion, create `.planning/phases/12-state-dashboard-polish/12-01-SUMMARY.md`
</output>
